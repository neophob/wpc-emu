!function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=6)}([function(t,e,s){(function(i){e.formatArgs=function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const s="color: "+this.color;e.splice(1,0,s,"color: inherit");let i=0,r=0;e[0].replace(/%[a-zA-Z%]/g,t=>{"%%"!==t&&(i++,"%c"===t&&(r=i))}),e.splice(r,0,s)},e.save=function(t){try{t?e.storage.setItem("debug",t):e.storage.removeItem("debug")}catch(s){}},e.load=function(){let t;try{t=e.storage.getItem("debug")}catch(s){}!t&&void 0!==i&&"env"in i&&(t=i.env.DEBUG);return t},e.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},e.storage=function(){try{return localStorage}catch(t){}}(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.log=console.debug||console.log||(()=>{}),t.exports=s(11)(e);const{formatters:r}=t.exports;r.j=function(t){try{return JSON.stringify(t)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}).call(this,s(3))},function(t,e,s){"use strict";t.exports={initializeEmulator:"initializeEmulator",resetEmulator:"resetEmulator",setCabinetInput:"setCabinetInput",setSwitchInput:"setSwitchInput",setFliptronicsInput:"setFliptronicsInput",toggleMidnightMadnessMode:"toggleMidnightMadnessMode",setDipSwitchByte:"setDipSwitchByte",getDipSwitchByte:"getDipSwitchByte",getVersion:"getVersion",registerAudioConsumer:"registerAudioConsumer",configureFrameRate:"configureFrameRate",writeMemory:"writeMemory",pauseEmulator:"pauseEmulator",resumeEmulator:"resumeEmulator",setEmulatorState:"setEmulatorState",getEmulatorState:"getEmulatorState",getEmulatorRomName:"getEmulatorRomName",MSG_TYPE_ACK:"MSG_TYPE_ACK",MSG_TYPE_ERROR:"MSG_TYPE_ERROR",MSG_TYPE_AUDIO_CALLBACK:"MSG_TYPE_AUDIO_CALLBACK",MSG_TYPE_UIDATA:"MSG_TYPE_UIDATA"}},function(t,e,s){"use strict";t.exports={CALL_IRQ_AFTER_TICKS:2049,CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS:512,CALL_ZEROCLEAR_AFTER_TICKS:16667,CALL_UPDATELAMP_AFTER_TICKS:6080,CALL_UPDATESOLENOID_AFTER_TICKS:48640,WATCHDOG_ARMED_FOR_TICKS:4162,UPDATE_ALPHANUMERIC_DISPLAY_TICKS:33e3}},function(t,e){var s,i,r=t.exports={};function a(){throw new Error("setTimeout has not been defined")}function h(){throw new Error("clearTimeout has not been defined")}function o(t){if(s===setTimeout)return setTimeout(t,0);if((s===a||!s)&&setTimeout)return s=setTimeout,setTimeout(t,0);try{return s(t,0)}catch(e){try{return s.call(null,t,0)}catch(e){return s.call(this,t,0)}}}!function(){try{s="function"==typeof setTimeout?setTimeout:a}catch(t){s=a}try{i="function"==typeof clearTimeout?clearTimeout:h}catch(t){i=h}}();var n,c=[],u=!1,d=-1;function g(){u&&n&&(u=!1,n.length?c=n.concat(c):d=-1,c.length&&C())}function C(){if(!u){var t=o(g);u=!0;for(var e=c.length;e;){for(n=c,c=[];++d<e;)n&&n[d].run();d=-1,e=c.length}n=null,u=!1,function(t){if(i===clearTimeout)return clearTimeout(t);if((i===h||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(t);try{i(t)}catch(e){try{return i.call(null,t)}catch(e){return i.call(this,t)}}}(t)}}function m(t,e){this.fun=t,this.array=e}function l(){}r.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var s=1;s<arguments.length;s++)e[s-1]=arguments[s];c.push(new m(t,e)),1!==c.length||u||o(C)},m.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=l,r.addListener=l,r.once=l,r.off=l,r.removeListener=l,r.removeAllListeners=l,r.emit=l,r.prependListener=l,r.prependOnceListener=l,r.listeners=function(t){return[]},r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(t,e,s){"use strict";t.exports={findMsbBit:function(t){const e=[1,2,4,8,16,32,64,128].indexOf(t);return e>-1?e+1:0},setMsbBit:function(t=0){return[1,2,4,8,16,32,64,128][t]}}},function(t,e,s){"use strict";const i=s(7),r=s(1),a=s(8);t.exports={initializeWebworkerAPI:function(t){return new h(t)},WebWorker:a};class h{constructor(t){if(!t&&!window.Worker)throw new Error("NO_WEBWORKER_SUPPORT");this.id=100,this.rpcProxy=i.build(),this.worker=t||new Worker("webworker.js"),this.worker.onmessage=(t={})=>{const e=t.data;if(this.audioConsumerCallback&&e.message===r.MSG_TYPE_AUDIO_CALLBACK)return this.audioConsumerCallback(e.sampleId);if(this.uiUpdateConsumerCallback&&e.message===r.MSG_TYPE_UIDATA)return this.uiUpdateConsumerCallback(e.parameter);this.rpcProxy.resolvePendingAnswerIfFoundFor(e)||console.warn("UNHANDLED_MESSAGE:",e)},this.worker.onerror=t=>{console.error("WEBWORKER_ON_ERROR",t)},this.worker.onmessageerror=t=>{console.error("WEBWORKER_ON_MESSAGE_ERROR",t)}}_sendMessage(t,e=2e3){this.id++;const s=[this.id].concat(t),i=this.rpcProxy.waitOnAnswer(this.id,e,t);return this.worker.postMessage(s),i}reset(){this.rpcProxy=i.build(),this.id=100}getStatistics(){return{averageRTTms:this.rpcProxy.getAverageRttMs(),sentMessages:this.id-100,failedMessages:this.rpcProxy.errorCounter}}initializeEmulator(t,e){return console.log("init emu"),this.reset(),this._sendMessage([r.initializeEmulator,{romData:t,gameEntry:e}],16e3)}resetEmulator(){return this._sendMessage([r.resetEmulator])}setCabinetInput(t){return this._sendMessage([r.setCabinetInput,t])}setSwitchInput(t,e){return this._sendMessage([r.setSwitchInput,t,e])}setFliptronicsInput(t,e){return this._sendMessage([r.setFliptronicsInput,t,e])}toggleMidnightMadnessMode(){return this._sendMessage([r.toggleMidnightMadnessMode])}setDipSwitchByte(t){return this._sendMessage([r.setDipSwitchByte])}getDipSwitchByte(){return this._sendMessage([r.getDipSwitchByte]).then(t=>t.parameter)}getVersion(){return this._sendMessage([r.getVersion]).then(t=>t.parameter)}getEmulatorRomName(){return this._sendMessage([r.getEmulatorRomName]).then(t=>t.parameter)}getEmulatorState(){return this._sendMessage([r.getEmulatorState]).then(t=>t.parameter)}setEmulatorState(t){return this._sendMessage([r.setEmulatorState,t])}registerAudioConsumer(t){return this.audioConsumerCallback=t,this._sendMessage([r.registerAudioConsumer])}registerUiUpdateConsumer(t){return this.uiUpdateConsumerCallback=t,Promise.resolve()}adjustFramerate(t){return this._sendMessage([r.configureFrameRate,t])}pauseEmulator(){return this._sendMessage([r.pauseEmulator])}resumeEmulator(){return this._sendMessage([r.resumeEmulator])}writeMemory(t,e){return this._sendMessage([r.writeMemory,t,e])}}},function(t,e,s){"use strict";s.r(e);var i=s(5);onmessage=t=>{i.WebWorker.handleMessage(t,postMessage)}},function(t,e,s){"use strict";const i=s(1);t.exports={build:function(t){return new r(t)}};class r{constructor(t=32){this.maximalPendingAnswers=t,this.pendingAnswers=new Map,this.averageRoundTripTimeArray=new Array(16),this.replyCounter=0,this.errorCounter=0}getAverageRttMs(){let t=.5;return this.averageRoundTripTimeArray.forEach(e=>{t+=e}),Number.parseInt(t/16,10)}waitOnAnswer(t,e,s){if(this.pendingAnswers.size>=this.maximalPendingAnswers&&(console.warn("MAXIMAL_PENDING_ANSWER_EXCEEDED",this.pendingAnswers.size),this.pendingAnswers.forEach(t=>{this.errorCounter++,t.promiseReject(new Error("MAXIMAL_PENDING_ANSWERS_REACHED_"+this.maximalPendingAnswers))}),this.pendingAnswers.clear()),this.pendingAnswers.has(t)){console.log("REMOVE DUPLICATE REQUEST");const e=this.pendingAnswers.get(t);this.pendingAnswers.delete(t),this.errorCounter++,e.promiseReject(new Error("DUPLICATE_REQUEST"))}return function(t,e){let s;const i=new Promise((t,i)=>{s=setTimeout(()=>{i(new Error("PROMISE_TIMEOUT_"+e))},e)});return Promise.race([t,i]).finally(()=>{clearTimeout(s)})}(new Promise((e,s)=>{const i={timestamp:Date.now(),promiseResolve:e,promiseReject:s,requestId:t};this.pendingAnswers.set(t,i)}),e).catch(e=>(console.warn("REMOVE_REJECTED_RESPONSE",{requestId:t,msg:e.message,debugMessage:JSON.stringify(s)}),this.pendingAnswers.delete(t),this.errorCounter++,Promise.reject(e))).then(e=>(this.pendingAnswers.delete(t),e))}resolvePendingAnswerIfFoundFor(t={}){if(!this.pendingAnswers.has(t.requestId))return console.log("requestId not found",t),console.log(this.pendingAnswers),!1;const e=this.pendingAnswers.get(t.requestId),s=this.replyCounter++%16;return this.averageRoundTripTimeArray[s]=Date.now()-e.timestamp,t.message===i.MSG_TYPE_ERROR?(e.promiseReject(new Error(t.parameter||e.requestId)),!0):(e.promiseResolve(t),!0)}}},function(t,e,s){const i=s(1),r=s(9);let a,h;t.exports={handleMessage:function(t,e){if(!e)throw new Error("POSTMESSAGE_FUNCTION_UNDEFINED");if(!t||!t.data||t.data.length<2)return console.error("INVALID_PARAMETER_SIZE"),void e({message:i.MSG_TYPE_ERROR,parameter:"INVALID_PARAMETER_SIZE"});const s=t.data[0],o=t.data[1],n=t.data[2];if(o===i.initializeEmulator)return r.buildWpcInstance(n.romData,n.gameEntry).then(t=>{a&&a.stop(),a=t,a.start(),e({message:i.MSG_TYPE_ACK,requestId:s})}).catch(t=>{e({message:i.MSG_TYPE_ERROR,parameter:t.message})});if(!a)return void e({message:i.MSG_TYPE_ERROR,requestId:s,parameter:"EMU_NOT_INITIALIZED"});switch(o){case i.resetEmulator:a.reset(),e({message:i.MSG_TYPE_ACK,requestId:s});break;case i.setCabinetInput:if(!Number.isInteger(n))return e({message:i.MSG_TYPE_ERROR,requestId:s,parameter:"INVALID_CABINET_INPUT_PARAMETER_"+n});a.setCabinetInput(n),e({message:i.MSG_TYPE_ACK,requestId:s});break;case i.setSwitchInput:const r=t.data.length>3?t.data[3]:void 0;a.setSwitchInput(n,r),e({message:i.MSG_TYPE_ACK,requestId:s,parameter:r});break;case i.setFliptronicsInput:const c=t.data.length>3?t.data[3]:void 0;a.setFliptronicsInput(n,c),e({message:i.MSG_TYPE_ACK,requestId:s,parameter:c});break;case i.toggleMidnightMadnessMode:a.toggleMidnightMadnessMode(),e({message:i.MSG_TYPE_ACK,requestId:s});break;case i.setDipSwitchByte:if(!n)return e({message:i.MSG_TYPE_ERROR,requestId:s,parameter:"MISSING_DIPSWITCH_PARAMETER"});a.setDipSwitchByte(n),e({message:i.MSG_TYPE_ACK,requestId:s});break;case i.getDipSwitchByte:const u=a.getDipSwitchByte();e({message:i.MSG_TYPE_ACK,requestId:s,parameter:u});break;case i.getVersion:{const t=a.getVersion();e({message:i.MSG_TYPE_ACK,requestId:s,parameter:t});break}case i.getEmulatorRomName:{const t=a.getEmulatorRomName();e({message:i.MSG_TYPE_ACK,requestId:s,parameter:t});break}case i.getEmulatorState:{const t=a.getEmulatorState();e({message:i.MSG_TYPE_ACK,requestId:s,parameter:t});break}case i.setEmulatorState:if(!n)return e({message:i.MSG_TYPE_ERROR,requestId:s,parameter:"MISSING_STATE_PARAMETER"});a.setEmulatorState(n),e({message:i.MSG_TYPE_ACK,requestId:s});break;case i.registerAudioConsumer:a.registerAudioConsumer(t=>{e({message:i.MSG_TYPE_AUDIO_CALLBACK,sampleId:t})}),e({message:i.MSG_TYPE_ACK,requestId:s});break;case i.getNextFrame:if(!h)return e({message:i.MSG_TYPE_ERROR,requestId:s,parameter:"NEXT_FRAME_NOT_READY"});e({message:i.MSG_TYPE_ACK,requestId:s,parameter:{emuState:h}}),h=void 0;break;case i.configureFrameRate:if(!Number.isInteger(n))return e({message:i.MSG_TYPE_ERROR,requestId:s,parameter:"INVALID_FRAMERATE_PARAMETER_"+n});a.configureFramerate(n),e({message:i.MSG_TYPE_ACK,requestId:s});break;case i.pauseEmulator:a.pause(),e({message:i.MSG_TYPE_ACK,requestId:s});break;case i.resumeEmulator:a.resume(),e({message:i.MSG_TYPE_ACK,requestId:s});break;case i.writeMemory:if(t.data.length<4)return e({message:i.MSG_TYPE_ERROR,requestId:s,parameter:"MISSING_PARAMETER"});a.writeMemory(n,t.data[3]),e({message:i.MSG_TYPE_ACK,requestId:s});break;default:return e({message:i.MSG_TYPE_ERROR,requestId:s,parameter:"UNKNOWN_MESSAGE_"+o})}},getEmu:function(){return a},clearState:function(){a&&a.stop();a=void 0,h=void 0}}},function(t,e,s){const i=s(10),r=s(1);t.exports={buildWpcInstance:function(t,e){if(!(t&&t.u06&&e&&e.rom))return Promise.reject(new Error("INVALID_PARAMETER"));const s={fileName:e.rom.u06,skipWpcRomCheck:e.skipWpcRomCheck,features:e.features,memoryPosition:e.memoryPosition};return i.initVMwithRom(t,s).then(t=>(console.log("EMU INITIALIZED!"),new a(t)))}};class a{constructor(t){this.emuInstance=t,this.intervalId=0,this.desiredFrameRate=5,this.ticksPerCall=Number.parseInt(2e6/this.desiredFrameRate,10)}configureFramerate(t){t<1||t>200?console.error("INVALID_FRAMERATE_IGNORED",t):(this.desiredFrameRate=t,console.log("desiredFrameRate:",this.desiredFrameRate),this.ticksPerCall=Number.parseInt(2e6/this.desiredFrameRate,10),this.intervalId&&this.resume())}start(){this.emuInstance.start()}getUiState(){return this.emuInstance.getUiState()}registerAudioConsumer(t){this.emuInstance.registerAudioConsumer(t)}setCabinetInput(t){this.emuInstance.setCabinetInput(t)}setSwitchInput(t,e){this.emuInstance.setSwitchInput(t,e)}setFliptronicsInput(t,e){this.emuInstance.setFliptronicsInput(t,e)}toggleMidnightMadnessMode(){this.emuInstance.toggleMidnightMadnessMode()}setDipSwitchByte(t){this.emuInstance.setDipSwitchByte(t)}getDipSwitchByte(){return this.emuInstance.getDipSwitchByte()}reset(){this.emuInstance.reset()}getVersion(){return this.emuInstance.version()}getEmulatorRomName(){return this.emuInstance.cpuBoard.romFileName}getEmulatorState(){return this.emuInstance.getState()}setEmulatorState(t){return this.emuInstance.setState(t)}_emuStep(){this.emuInstance.executeCycle(this.ticksPerCall,16);const t={emuState:this.emuInstance.getUiState()};postMessage({message:r.MSG_TYPE_UIDATA,parameter:t})}emuStepByTime(t,e){this.emuInstance.emuStepByTime(t,e)}stop(){clearInterval(this.intervalId),this.intervalId=!1}pause(){this.intervalId||this._emuStep();const t={emuState:this.emuInstance.getUiState()};postMessage({message:r.MSG_TYPE_UIDATA,parameter:t}),this.stop()}resume(){this.intervalId&&this.pause();const t=1e3/this.desiredFrameRate;console.log("resume emu",t),this.intervalId=setInterval(()=>{this._emuStep()},t)}writeMemory(t,e){this.emuInstance.cpuBoard.writeMemory(t,e)}}},function(t,e,s){"use strict";(function(e){const i=s(0),r=s(13),a=s(14),h=s(16),o=s(41),n=i("Emulator");t.exports={initVMwithRom:function(t,e){return n("initVMwithRom",Object.keys(t),e),a.parse(t,e).then(t=>(n("loading rom successful"),new c(t)))},getVersion:function(){return r.version}};class c{constructor(t){this.cpuBoard=h.getInstance(t),this.uiFacade=o.getInstance(t.memoryPosition)}start(){n("Start WPC Emulator"),this.startTime=Date.now(),this.cpuBoard.start()}getUiState(t=!0){const e=this.cpuBoard.getState(),s=this.uiFacade.getChangedAsicState(e.asic,t);e.asic=s;const i=Date.now()-this.startTime;return e.opsMs=Number.parseInt(e.cpuState.tickCount/i,10),e.runtime=i,e}getState(){return this.cpuBoard.getState()}setState(t){return this.cpuBoard.setState(t)}registerAudioConsumer(t){this.cpuBoard.registerSoundBoardCallback(t)}executeCycle(t=500,e=4){return this.cpuBoard.executeCycle(t,e)}executeCycleForTime(t,e){const s=2e3*t;return this.executeCycle(s,e)}setCabinetInput(t){this.cpuBoard.setCabinetInput(t)}setSwitchInput(t,e){this.cpuBoard.setSwitchInput(t,e)}setFliptronicsInput(t,e){this.cpuBoard.setFliptronicsInput(t,e)}toggleMidnightMadnessMode(){this.cpuBoard.toggleMidnightMadnessMode()}setDipSwitchByte(t){this.cpuBoard.setDipSwitchByte(t)}getDipSwitchByte(){return this.cpuBoard.getDipSwitchByte()}reset(){n("RESET!"),this.startTime=Date.now(),this.cpuBoard.reset()}version(){return r.version}}e.on("uncaughtException",t=>{console.error("UNCAUGHT_EXCEPTION",{error:t.message})}),e.on("unhandledRejection",t=>{console.error("UNHANDLED_REJECTION",{msg:t.message,stack:t.stack})})}).call(this,s(3))},function(t,e,s){t.exports=function(t){function e(t){let s;function a(...t){if(!a.enabled)return;const i=a,r=Number(new Date),h=r-(s||r);i.diff=h,i.prev=s,i.curr=r,s=r,t[0]=e.coerce(t[0]),"string"!=typeof t[0]&&t.unshift("%O");let o=0;t[0]=t[0].replace(/%([a-zA-Z%])/g,(s,r)=>{if("%%"===s)return s;o++;const a=e.formatters[r];if("function"==typeof a){const e=t[o];s=a.call(i,e),t.splice(o,1),o--}return s}),e.formatArgs.call(i,t);(i.log||e.log).apply(i,t)}return a.namespace=t,a.enabled=e.enabled(t),a.useColors=e.useColors(),a.color=e.selectColor(t),a.destroy=i,a.extend=r,"function"==typeof e.init&&e.init(a),e.instances.push(a),a}function i(){const t=e.instances.indexOf(this);return-1!==t&&(e.instances.splice(t,1),!0)}function r(t,s){const i=e(this.namespace+(void 0===s?":":s)+t);return i.log=this.log,i}function a(t){return t.toString().substring(2,t.toString().length-2).replace(/\.\*\?$/,"*")}return e.debug=e,e.default=e,e.coerce=function(t){if(t instanceof Error)return t.stack||t.message;return t},e.disable=function(){const t=[...e.names.map(a),...e.skips.map(a).map(t=>"-"+t)].join(",");return e.enable(""),t},e.enable=function(t){let s;e.save(t),e.names=[],e.skips=[];const i=("string"==typeof t?t:"").split(/[\s,]+/),r=i.length;for(s=0;s<r;s++)i[s]&&("-"===(t=i[s].replace(/\*/g,".*?"))[0]?e.skips.push(new RegExp("^"+t.substr(1)+"$")):e.names.push(new RegExp("^"+t+"$")));for(s=0;s<e.instances.length;s++){const t=e.instances[s];t.enabled=e.enabled(t.namespace)}},e.enabled=function(t){if("*"===t[t.length-1])return!0;let s,i;for(s=0,i=e.skips.length;s<i;s++)if(e.skips[s].test(t))return!1;for(s=0,i=e.names.length;s<i;s++)if(e.names[s].test(t))return!0;return!1},e.humanize=s(12),Object.keys(t).forEach(s=>{e[s]=t[s]}),e.instances=[],e.names=[],e.skips=[],e.formatters={},e.selectColor=function(t){let s=0;for(let e=0;e<t.length;e++)s=(s<<5)-s+t.charCodeAt(e),s|=0;return e.colors[Math.abs(s)%e.colors.length]},e.enable(e.load()),e}},function(t,e){var s=1e3,i=6e4,r=60*i,a=24*r;function h(t,e,s,i){var r=e>=1.5*s;return Math.round(t/s)+" "+i+(r?"s":"")}t.exports=function(t,e){e=e||{};var o=typeof t;if("string"===o&&t.length>0)return function(t){if((t=String(t)).length>100)return;var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(!e)return;var h=parseFloat(e[1]);switch((e[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*h;case"weeks":case"week":case"w":return 6048e5*h;case"days":case"day":case"d":return h*a;case"hours":case"hour":case"hrs":case"hr":case"h":return h*r;case"minutes":case"minute":case"mins":case"min":case"m":return h*i;case"seconds":case"second":case"secs":case"sec":case"s":return h*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return h;default:return}}(t);if("number"===o&&isFinite(t))return e.long?function(t){var e=Math.abs(t);if(e>=a)return h(t,e,a,"day");if(e>=r)return h(t,e,r,"hour");if(e>=i)return h(t,e,i,"minute");if(e>=s)return h(t,e,s,"second");return t+" ms"}(t):function(t){var e=Math.abs(t);if(e>=a)return Math.round(t/a)+"d";if(e>=r)return Math.round(t/r)+"h";if(e>=i)return Math.round(t/i)+"m";if(e>=s)return Math.round(t/s)+"s";return t+"ms"}(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))}},function(t){t.exports=JSON.parse('{"name":"wpc-emu","version":"0.36.7","description":"WPC pinball machine emu","author":"Michael Vogt <michu@neophob.com>","homepage":"https://github.com/neophob/wpc-emu","main":"index.js","types":"./types/index.d.ts","engines":{"node":">=10.0.0"},"repository":{"type":"git","url":"git://github.com/neophob/wpc-emu"},"license":"ISC","devDependencies":{"ava":"^3.13.0","copy-webpack-plugin":"^6.2.1","http-server":"^0.12.3","nyc":"^15.1.0","remove-debug-loader":"^0.2.6","sinon":"^9.2.0","terser-webpack-plugin":"^5.0.0","webpack":"^5.1.0","webpack-cli":"^4.0.0","xo":"^0.33.1"},"dependencies":{"debug":"^4.2.0"},"xo":{"envs":["node","browser"],"space":true,"rules":{"comma-dangle":0,"arrow-parens":0,"no-var":0,"comma-spacing":0,"capitalized-comments":0,"promise/prefer-await-to-then":0,"ava/prefer-async-await":0,"no-use-before-define":0,"spaced-comment":0,"object-curly-spacing":0,"array-bracket-spacing":0,"padded-blocks":0,"no-mixed-operators":0,"unicorn/import-index":0,"new-cap":0,"prefer-destructuring":0,"no-use-extend-native/no-use-extend-native":0,"padding-line-between-statements":0,"array-element-newline":0},"ignores":["client","docs","test/tracer/disasm.js"]},"ava":{"files":["test/lib/**/*.test.js"],"verbose":true},"scripts":{"build":"webpack --mode development","watch":"webpack --mode development --watch","build:production":"webpack --mode production","start":"DEBUG=* node example.js","start:fileserv":"cp -fr ./rom ./dist && npm run start:webserver","start:fileserv:prod":"cp -fr ./rom ./docs && npm run start:webserver","start:webserver":"http-server ./dist -S -C assets/localhost-cert/server.crt -K assets/localhost-cert/server.key --cors -p 8080 || echo \'\\n\\nERROR. Did you created and install the local dev certificates? Heres the content:\' && cat assets/localhost-cert/README.md","debug":"node --inspect example.js","xo":"xo","test":"nyc ava --verbose","test:coverage":"nyc report --reporter=html","test:debug":"DEBUG=\'wpc*\' ava --fail-fast --verbose","test:integration":"ava --config integration.ava.cjs","test:runner":"node test/headless-runner.js","tracer:dump":"cd ./test/tracer && ./_runbig.sh","tracer:stats":"cd ./test/tracer && ./_runbig.sh stats > stats.txt","tracer:status":"cd ./test/tracer/wpc-emu-dumps && git status","tracer:diff":"cd ./test/tracer/wpc-emu-dumps && git diff","benchmark":"node test/integration/benchmark.js > /dev/null","benchmark:t2":"CYCLES=20000000 ROMFILE=./rom/t2_l8.rom node test/integration/benchmark.js > /dev/null","release":"./build/docker-wrapper.sh"}}')},function(t,e,s){"use strict";const i=s(0)("wpcemu:rom:loader"),r=s(15),a=[1,2,4,8],h=["wpcDmd","wpcFliptronics"];t.exports={parse:function(t,e={}){return new Promise((s,o)=>{if("object"!=typeof t)return o(new Error("INVALID_ROM_DATA"));i("LOAD_GAME_ROM");const n=t.u06,c=n.length/131072;i("systemRom (u06) size: %s bytes, mbit size: %s",n.length,c);const u=!Number.isInteger(c),d=!a.includes(c);if(u||d)return i("romSizeMBit",c),o(new Error("INVALID_ROM_SIZE"));const g=function(t){const e=t.subarray(t.length-32768,t.length);return i("systemRom checksum correction",e[32748]),i("systemRom checksum",e[32749]),i("systemRom version",e[32750]),e}(n),C=(m=n).subarray(0,m.length-32768);var m;const l=r.search(C,g),S=Array.isArray(e.features);s({romSizeMBit:c,systemRom:g,gameRom:C,gameIdMemoryLocation:l,fileName:e.fileName||"Unknown",skipWpcRomCheck:!0===e.skipWpcRomCheck,hasSecurityPic:S&&e.features.includes("securityPic"),wpc95:S&&e.features.includes("wpc95"),hasAlphanumericDisplay:S&&e.features.includes("wpcAlphanumeric"),preDcsSoundboard:S&&(e.features.includes(h[0])||e.features.includes(h[1])),memoryPosition:e.memoryPosition})})}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:rom:gameId");t.exports={search:function(t,e){i("SEARCH GAME ID IN ROM");let s=0;for(let r=0;r<t.length-7;r++){if(236===t[r]&&159===t[r+1]){if(131===t[r+4]&&18===t[r+5]&&52===t[r+6]&&2==++s){let s=(t[r+2]<<8)+t[r+3];if(s-=32768,s<0)throw new Error("INVALID_MEMORY_POSITION_"+s);const a=(e[s]<<8)+e[s+1];return i("GAMEID_FOUND",a),console.log("GAMEID_FOUND",a),a}}}i("GAME ID NOT FOUND")}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:cpu-board"),r=s(17),a=s(18),h=s(2),o=s(19),n=s(27),c=s(30),u=s(31),d=s(33),g=s(34),C=s(35),m=s(36),l=s(40);t.exports={getInstance:function(t){return new S(t)}};class S{constructor(t){this.ram=new Uint8Array(r.MEMORY_ADDR_HARDWARE).fill(0),this.romSizeMBit=t.romSizeMBit,this.systemRom=t.systemRom,this.romFileName=t.fileName,this.gameRom=t.gameRom,this.memoryPatch=d.getInstance(),t.gameIdMemoryLocation&&g.run(this.memoryPatch,t.gameIdMemoryLocation),!0===t.skipWpcRomCheck&&(i("skipWpcRomCheck TRUE"),C.run(this.memoryPatch)),this.memoryWriteHandler=u.getInstance(t.memoryPosition,this.ram);const e=this._read8.bind(this),s=this._write8.bind(this);this.cpu=l.getInstance(s,e);const a={interruptCallback:{irq:this.cpu.irq,firqFromDmd:()=>{this.cpu.firq(),this.asic.firqSourceDmd(!0)},reset:this.cpu.reset},romSizeMBit:this.romSizeMBit,romObject:t,ram:this.ram,hasAlphanumericDisplay:t.hasAlphanumericDisplay};this.hasAlphaNumbericDisplay=t.hasAlphanumericDisplay,this.asic=o.getInstance(a),this.soundBoard=n.getInstance(a),this.displayBoard=m.getInstance(a),this.externalIo=c.getInstance(),this.ticksIrq=0,this.protectedMemoryWriteAttempts=0,this.memoryWrites=0}reset(){console.log("RESET_CPU_BOARD"),this.ticksIrq=0,this.protectedMemoryWriteAttempts=0,this.memoryWrites=0,this.memoryPatch.removeVolatileEntries(),this.displayBoard.reset(),this.soundBoard.reset(),this.asic.reset(),this.cpu.reset()}getState(){const t={ram:this.memoryPatch.applyPatchesToExposedMemory(this.ram),wpc:this.asic.getState(),display:this.displayBoard.getState(),sound:this.soundBoard.getState()},e=this.cpu.getState();return{asic:t,romFileName:this.romFileName,cpuState:e,protectedMemoryWriteAttempts:this.protectedMemoryWriteAttempts,memoryWrites:this.memoryWrites,ticksIrq:this.ticksIrq,version:5}}setState(t){if(!t||!t.asic||5!==t.version)return console.log("INVALID_STATE_VERSION_OR_DATA"),!1;this.cpu.setState(t.cpuState),this.protectedMemoryWriteAttempts=t.protectedMemoryWriteAttempts,this.memoryWrites=t.memoryWrites,this.ticksIrq=t.ticksIrq,this.asic.setState(t.asic.wpc),this.displayBoard.setState(t.asic.display),this.soundBoard.setState(t.asic.sound),"object"==typeof t.asic.ram&&this.ram.set(Uint8Array.from(t.asic.ram),0)}setCabinetInput(t){this.asic.setCabinetInput(t)}setSwitchInput(t,e){this.asic.setSwitchInput(t,e)}setFliptronicsInput(t,e){this.asic.setFliptronicsInput(t,e)}toggleMidnightMadnessMode(){this.asic.toggleMidnightMadnessMode()}setDipSwitchByte(t){this.asic.setDipSwitchByte(t)}getDipSwitchByte(){return this.asic.getDipSwitchByte()}registerSoundBoardCallback(t){this.soundBoard.registerSoundBoardCallback(t)}start(){console.log("RESET_SYSTEM"),this.reset(),i("PC",this.cpu.getState().regPC)}executeCycle(t,e){let s=0;for(;s<t;){const t=this.cpu.steps(e);s+=t,this.ticksIrq+=t,this.ticksIrq>=h.CALL_IRQ_AFTER_TICKS&&(this.ticksIrq-=h.CALL_IRQ_AFTER_TICKS,this.cpu.irq()),this.displayBoard.executeCycle(t),this.asic.executeCycle(t)}return i("CPUSTATE %o",{ticks:this.cpu.tickCount,irqExecuted:this.cpu.irqCount,irqMissed:this.cpu.missedIRQ,firqExecuted:this.cpu.firqCount,firqMissed:this.cpu.missedFIRQ}),s}writeMemory(t,e){i("writeMemory",{offset:t}),this.memoryWriteHandler.writeMemory(t,e)}_read8(t){if(!t&&0!==t)throw new TypeError("CPU_MEMORY_READ_BUG_DETECTED!");const e=this.memoryPatch.hasPatch(t);if(e)return e.value;const s=r.getAddress(t);switch(s.subsystem){case r.SUBSYSTEM_RAM:return this.ram[s.offset];case r.SUBSYSTEM_HARDWARE:return this._hardwareRead(s.offset);case r.SUBSYSTEM_BANKSWITCHED:return this._bankswitchedRead(s.offset);case r.SUBSYSTEM_SYSTEMROM:return this.systemRom[s.offset];default:throw new Error("INVALID_READ_SUBSYSTEM")}}_write8(t,e){if(!t&&0!==t)throw console.log("CPU_MEMORY_WRITE_BUG_DETECTED",{offset:t,value:e}),new TypeError("CPU_MEMORY_WRITE_BUG_DETECTED!");e&=255;const s=r.getAddress(t);switch(s.subsystem){case r.SUBSYSTEM_RAM:this.asic.isMemoryProtectionEnabled()||(t&this.asic.memoryProtectionMask)!==this.asic.memoryProtectionMask?(this.ram[s.offset]=e,this.memoryWrites++):(i("DID_NOT_WRITE_MEMORY_PROTECTED",t.toString(16),e),this.protectedMemoryWriteAttempts++);break;case r.SUBSYSTEM_HARDWARE:this._hardwareWrite(t,e);break;case r.SUBSYSTEM_SYSTEMROM:i("SYSTEMROM_WRITE",{offset:t.toString(16),value:e}),console.log("SYSTEMROM_WRITE",{offset:t.toString(16),value:e}),this.systemRom[s.offset]=e;break;default:console.log("CPU_WRITE8_FAIL",JSON.stringify(s),t,e)}}_bankswitchedRead(t){const e=this.asic.romBank,s=t+16384*e;return i("R_GAMEROM_BANK %o",{activeBank:e,offset:t,pageOffset:s,data:this.gameRom[s],romlength:this.gameRom.length}),this.gameRom[s]||0}_hardwareWrite(t,e){this.ram[t]=e;const s=a.getAddress(t,this.hasAlphaNumbericDisplay);switch(s.subsystem){case a.SUBSYSTEM_DISPLAY:this.displayBoard.write(t,e);break;case a.SUBSYSTEM_EXTERNAL_IO:this.externalIo.write(t,e);break;case a.SUBSYSTEM_SOUND:this.soundBoard.writeInterface(t,e);break;case a.SUBSYSTEM_WPCIO:this.asic.write(t,e);break;default:throw console.log(JSON.stringify(s)),new Error("CPUBOARD_INVALID_HW_WRITE")}}_hardwareRead(t){const e=a.getAddress(t,this.hasAlphaNumbericDisplay);switch(e.subsystem){case a.SUBSYSTEM_DISPLAY:return this.displayBoard.read(t);case a.SUBSYSTEM_EXTERNAL_IO:return this.externalIo.read(t);case a.SUBSYSTEM_SOUND:return this.soundBoard.readInterface(t);case a.SUBSYSTEM_WPCIO:return this.asic.read(t);default:throw console.log(JSON.stringify(e)),new Error("INVALID_HW_READ")}}}},function(t,e,s){"use strict";t.exports={getAddress:function(t){if(void 0===t)throw new Error("MEMORY_GET_ADDRESS_UNDEFINED");const e=(t&=65535)>=15360&&t<=16303;if(t<12288||e)return{offset:t,subsystem:"ram"};if(t<16384)return{offset:t,subsystem:"hardware"};if(t<32768)return{offset:t-16384,subsystem:"bank"};if(t<65536)return{offset:t-32768,subsystem:"system"};throw new Error("MEMORY_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16))},MEMORY_ADDR_RAM:12288,MEMORY_ADDR_HARDWARE:16384,SUBSYSTEM_RAM:"ram",SUBSYSTEM_HARDWARE:"hardware",SUBSYSTEM_BANKSWITCHED:"bank",SUBSYSTEM_SYSTEMROM:"system"}},function(t,e,s){"use strict";const i=[16363,16364,16365,16366,16367];function r(t,e){return{offset:t,subsystem:e}}t.exports={getAddress:function(t,e){if(void 0===t)throw new Error("HW_GET_ADDRESS_UNDEFINED");if((t&=65535)<12288)throw new Error("HW_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16));if(t<16320||e&&i.includes(t))return r(t,"display");if(16340===t||16367===t)return r(t,"wpcio");if(t<16348)return r(t,"externalIo");if(t<16352)return r(t,"sound");if(t<16384)return r(t,"wpcio");throw new Error("HW_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16))},SUBSYSTEM_WPCIO:"wpcio",SUBSYSTEM_SOUND:"sound",SUBSYSTEM_EXTERNAL_IO:"externalIo",SUBSYSTEM_DISPLAY:"display"}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:asic"),r=s(2),a=s(20),h=s(21),o=s(22),n=s(23),c=s(24),u=s(25),d=s(26),g={WPC_FLIPTRONICS_FLIPPER_PORT_A:16340,WPC_SOLENOID_GEN_OUTPUT:16352,WPC_SOLENOID_HIGHPOWER_OUTPUT:16353,WPC_SOLENOID_FLASH1_OUTPUT:16354,WPC_SOLENOID_LOWPOWER_OUTPUT:16355,WPC_LAMP_ROW_OUTPUT:16356,WPC_LAMP_COL_STROBE:16357,WPC_GI_TRIAC:16358,WPC_SW_JUMPER_INPUT:16359,WPC_SWITCH_CABINET_INPUT:16360,WPC_SWITCH_ROW_SELECT:16361,WPC_SWITCH_COL_SELECT:16362,WPC_PICREAD:16361,WPC_PICWRITE:16362,WPC_EXTBOARD1:16363,WPC_EXTBOARD2:16364,WPC_EXTBOARD3:16365,WPC95_FLIPPER_COIL_OUTPUT:16366,WPC95_FLIPPER_SWITCH_INPUT:16367,WPC_LEDS:16370,WPC_RAM_BANK:16371,WPC_SHIFTADDRH:16372,WPC_SHIFTADDRL:16373,WPC_SHIFTBIT:16374,WPC_SHIFTBIT2:16375,WPC_PERIPHERAL_TIMER_FIRQ_CLEAR:16376,WPC_ROM_LOCK:16377,WPC_CLK_HOURS_DAYS:16378,WPC_CLK_MINS:16379,WPC_ROM_BANK:16380,WPC_RAM_LOCK:16381,WPC_RAM_LOCKSIZE:16382,WPC_ZEROCROSS_IRQ_CLEAR:16383},C=[];Object.keys(g).forEach(t=>{C[g[t]]=t});const m=[0,7,15,0,31,0,0,0,63],l=new Date("December 17, 1995 23:59:45").getTime();t.exports={getInstance:function(t){return new S(t)},OP:g};class S{constructor(t){if(this.interruptCallback=t.interruptCallback,this.pageMask=m[t.romSizeMBit],0===this.pageMask)throw new Error("PAGEMASK_EMPTY");i("pageMask calculated %o",{pageMask:this.pageMask,romSizeMBit:t.romSizeMBit}),this.ram=t.ram,this.hardwareHasSecurityPic=t.romObject&&t.romObject.hasSecurityPic,this.inputSwitchMatrix=h.getInstance(),this.outputLampMatrix=o.getInstance(r.CALL_UPDATELAMP_AFTER_TICKS),this.outputSolenoidMatrix=n.getInstance(r.CALL_UPDATESOLENOID_AFTER_TICKS);const e=t.romObject&&t.romObject.wpc95;this.outputGeneralIllumination=c.getInstance(e),this.securityPic=d.getInstance(),this.periodicIRQTimerEnabled=!0,this.romBank=0,this.diagnosticLedToggleCount=0,this.oldDiagnostigLedState=0,this._firqSourceDmd=!1,this.irqCountGI=0,this.zeroCrossFlag=0,this.ticksZeroCross=0,this.memoryProtectionMask=null,this.midnightMadnessMode=Date.now(),this.midnightModeEnabled=!1,this.blankSignalHigh=!0,this.watchdogTicks=0,this.watchdogExpiredCounter=0,this.dipSwitchSetting=a.USA}reset(){console.log("RESET_ASIC"),this.periodicIRQTimerEnabled=!0,this.romBank=0,this.diagnosticLedToggleCount=0,this.oldDiagnostigLedState=0,this._firqSourceDmd=!1,this.irqCountGI=0,this.zeroCrossFlag=0,this.ticksZeroCross=0,this.memoryProtectionMask=null,this.hardwareHasSecurityPic&&this.securityPic.reset(),this.midnightMadnessMode=Date.now(),this.midnightModeEnabled=!1,this.blankSignalHigh=!0,this.watchdogTicks=r.WATCHDOG_ARMED_FOR_TICKS,this.watchdogExpiredCounter=0}getState(){let t=this.getTime().toTimeString().split(" ")[0];return this.midnightModeEnabled&&(t+=" MM!"),{diagnosticLed:this.ram[g.WPC_LEDS],lampState:this.outputLampMatrix.lampState,lampRow:this.outputLampMatrix.activeRow,lampColumn:this.outputLampMatrix.activeColumn,solenoidState:this.outputSolenoidMatrix.solenoidState,generalIlluminationState:this.outputGeneralIllumination.getNormalizedState(),inputState:this.inputSwitchMatrix.switchState,inputSwitchMatrixActiveColumn:this.inputSwitchMatrix.activeColumn,diagnosticLedToggleCount:this.diagnosticLedToggleCount,irqEnabled:this.periodicIRQTimerEnabled,activeRomBank:this.romBank,zeroCrossFlag:this.zeroCrossFlag,ticksZeroCross:this.ticksZeroCross,memoryProtectionMask:this.memoryProtectionMask,firqSourceDmd:this._firqSourceDmd,irqCountGI:this.irqCountGI,midnightModeEnabled:this.midnightModeEnabled,time:t,blankSignalHigh:this.blankSignalHigh,watchdogExpiredCounter:this.watchdogExpiredCounter,watchdogTicks:this.watchdogTicks,wpcSecureScrambler:this.securityPic.getScrambler()}}setState(t){if(!t)return!1;this.inputSwitchMatrix.activeColumn=t.inputSwitchMatrixActiveColumn,this.diagnosticLedToggleCount=t.diagnosticLedToggleCount,this.periodicIRQTimerEnabled=t.irqEnabled,this.romBank=t.activeRomBank,this.zeroCrossFlag=t.zeroCrossFlag,this.ticksZeroCross=t.ticksZeroCross,this.memoryProtectionMask=t.memoryProtectionMask,this._firqSourceDmd=t.firqSourceDmd,this.irqCountGI=t.irqCountGI,this.midnightModeEnabled=t.midnightModeEnabled,this.blankSignalHigh=!0===t.blankSignalHigh,this.watchdogExpiredCounter=t.watchdogExpiredCounter,"object"==typeof t.lampState&&(this.outputLampMatrix.lampState=Uint8Array.from(t.lampState)),"object"==typeof t.solenoidState&&(this.outputSolenoidMatrix.solenoidState=Uint8Array.from(t.solenoidState)),"object"==typeof t.generalIlluminationState&&(this.outputGeneralIllumination.generalIlluminationState=Uint8Array.from(t.generalIlluminationState)),"object"==typeof t.inputState&&(this.inputSwitchMatrix.switchState=Uint8Array.from(t.inputState))}setZeroCrossFlag(){i("SET_ZEROCROSS_FLAG"),this.zeroCrossFlag=1}setCabinetInput(t){i("setCabinetInput",t),this.inputSwitchMatrix.setCabinetKey(255&t)}setSwitchInput(t,e){i("setSwitchInput",t,e),this.inputSwitchMatrix.setInputKey(255&t,e)}setFliptronicsInput(t,e){this.inputSwitchMatrix.setFliptronicsInput(t,e)}firqSourceDmd(t){i("firqSourceDmd",t),this._firqSourceDmd=!0===t}toggleMidnightMadnessMode(){this.midnightMadnessMode=Date.now(),this.midnightModeEnabled=!this.midnightModeEnabled}setDipSwitchByte(t){i("setDipSwitchByte",t),this.dipSwitchSetting=t}getDipSwitchByte(){return this.dipSwitchSetting}executeCycle(t){this.ticksZeroCross+=t,this.ticksZeroCross>=r.CALL_ZEROCLEAR_AFTER_TICKS&&(this.ticksZeroCross-=r.CALL_ZEROCLEAR_AFTER_TICKS,this.setZeroCrossFlag()),this.watchdogTicks-=t,this.watchdogTicks<0&&(i("WATCHDOG_EXPIRED",this.watchdogTicks),this.watchdogTicks=r.WATCHDOG_ARMED_FOR_TICKS,this.watchdogExpiredCounter++),this.outputLampMatrix.executeCycle(t),this.outputSolenoidMatrix.executeCycle(t)}isMemoryProtectionEnabled(){return 180===this.ram[g.WPC_RAM_LOCK]}getTime(){return this.midnightModeEnabled?new Date(l+Date.now()-this.midnightMadnessMode):new Date}write(t,e){switch(this.ram[t]=e,t){case g.WPC_RAM_LOCK:case g.WPC_RAM_BANK:case g.WPC_CLK_HOURS_DAYS:case g.WPC_CLK_MINS:case g.WPC_SHIFTADDRH:case g.WPC_SHIFTADDRL:case g.WPC_SHIFTBIT:case g.WPC_SHIFTBIT2:case g.WPC_ROM_LOCK:case g.WPC_EXTBOARD1:case g.WPC_EXTBOARD2:case g.WPC_EXTBOARD3:i("WRITE",C[t],e);break;case g.WPC95_FLIPPER_COIL_OUTPUT:i("WRITE",C[t],e),this.outputSolenoidMatrix.writeFliptronic(255&e);break;case g.WPC95_FLIPPER_SWITCH_INPUT:case g.WPC_FLIPTRONICS_FLIPPER_PORT_A:i("WRITE",C[t],e),this.outputSolenoidMatrix.writeFliptronic(255&~e);break;case g.WPC_RAM_LOCKSIZE:this.isMemoryProtectionEnabled()?(this.memoryProtectionMask=u.getMemoryProtectionMask(e),i("UPDATED_MEMORY_PROTECTION_MASK",this.memoryProtectionMask)):i("MEMORY_PROTECTION_DISABLED",e);break;case g.WPC_SWITCH_COL_SELECT:if(i("WRITE",C[t],e),this.hardwareHasSecurityPic)return this.securityPic.write(e);this.inputSwitchMatrix.setActiveColumn(e);break;case g.WPC_GI_TRIAC:i("WRITE",C[t],e),this.outputGeneralIllumination.update(e,this.irqCountGI);break;case g.WPC_LAMP_ROW_OUTPUT:i("WRITE",C[t],e),this.outputLampMatrix.setActiveRow(e);break;case g.WPC_LAMP_COL_STROBE:i("WRITE",C[t],e),this.outputLampMatrix.setActiveColumn(e);break;case g.WPC_PERIPHERAL_TIMER_FIRQ_CLEAR:i("WRITE",C[t],{_firqSourceDmd:this._firqSourceDmd,value:e}),this._firqSourceDmd=!1;break;case g.WPC_SOLENOID_GEN_OUTPUT:case g.WPC_SOLENOID_HIGHPOWER_OUTPUT:case g.WPC_SOLENOID_FLASH1_OUTPUT:case g.WPC_SOLENOID_LOWPOWER_OUTPUT:i("WRITE",C[t],e),this.outputSolenoidMatrix.write(t,e);break;case g.WPC_LEDS:i("WRITE",C[t],e),e!==this.oldDiagnostigLedState&&(i("DIAGNOSTIC_LED_TOGGLE",this.oldDiagnostigLedState,e),this.diagnosticLedToggleCount++,this.oldDiagnostigLedState=e);break;case g.WPC_ROM_BANK:{const t=e&this.pageMask;i("SELECT WPC_ROM_BANK",{value:e,bank:t}),this.romBank=t;break}case g.WPC_ZEROCROSS_IRQ_CLEAR:{4&e&&(this.watchdogTicks=r.WATCHDOG_ARMED_FOR_TICKS,i("WPC_ZC_WATCHDOG_RESET: RESET WATCHDOG",this.watchdogTicks)),this.blankSignalHigh&&2&e&&(i("CLEAR_BLANKING_SIGNAL"),this.blankSignalHigh=!1),128&e&&(i("WRITE WPC_ZEROCROSS_IRQ_CLEAR",e),this.irqCountGI++);const t=(16&e)>0;t!==this.periodicIRQTimerEnabled&&(i("WRITE WPC_ZEROCROSS_IRQ_CLEAR periodic timer changed",e),this.periodicIRQTimerEnabled=t);break}default:i("W_NOT_IMPLEMENTED","0x"+t.toString(16),e),console.log("ASIC_WRITE_NOT_IMPLEMENTED","0x"+t.toString(16),e)}}read(t){let e;switch(t){case g.WPC_LEDS:case g.WPC_RAM_BANK:case g.WPC_ROM_LOCK:case g.WPC_EXTBOARD1:case g.WPC_EXTBOARD2:case g.WPC_EXTBOARD3:return i("READ",C[t],this.ram[t]),this.ram[t];case g.WPC95_FLIPPER_COIL_OUTPUT:case g.WPC95_FLIPPER_SWITCH_INPUT:case g.WPC_FLIPTRONICS_FLIPPER_PORT_A:return i("READ",C[t]),this.inputSwitchMatrix.getFliptronicsKeys();case g.WPC_RAM_LOCK:case g.WPC_RAM_LOCKSIZE:return i("READ",C[t],this.ram[t]),this.ram[t];case g.WPC_SWITCH_CABINET_INPUT:return i("READ",C[t]),this.inputSwitchMatrix.getCabinetKey();case g.WPC_ROM_BANK:return i("READ",C[t],this.ram[t]),this.ram[t]&this.pageMask;case g.WPC_SWITCH_ROW_SELECT:return i("READ",C[t]),this.hardwareHasSecurityPic?this.securityPic.read(t=>this.inputSwitchMatrix.getRow(t)):this.inputSwitchMatrix.getActiveRow();case g.WPC_SHIFTADDRH:return e=this.ram[g.WPC_SHIFTADDRH]+(this.ram[g.WPC_SHIFTADDRL]+(this.ram[g.WPC_SHIFTBIT]>>>3)>>>8)&255,i("READ",C[t],e),e;case g.WPC_SHIFTADDRL:return e=this.ram[g.WPC_SHIFTADDRL]+(this.ram[g.WPC_SHIFTBIT]>>>3)&255,i("READ",C[t],e),e;case g.WPC_SHIFTBIT:case g.WPC_SHIFTBIT2:return i("READ",C[t],this.ram[t]),1<<(7&this.ram[t]);case g.WPC_CLK_HOURS_DAYS:{e=this.getTime(),i("READ WPC_CLK_HOURS_DAYS");let t=0;return t+=this.ram[6144]=e.getFullYear()>>8,t+=this.ram[6145]=255&e.getFullYear(),t+=this.ram[6146]=e.getMonth()+1,t+=this.ram[6147]=e.getDate(),t+=this.ram[6148]=e.getDay()+1,t+=this.ram[6149]=0,t+=this.ram[6150]=1,t=65535-t,this.ram[6151]=t>>8,this.ram[6152]=255&t,e.getHours()}case g.WPC_CLK_MINS:return e=this.getTime(),i("READ WPC_CLK_MINS"),e.getMinutes();case g.WPC_SW_JUMPER_INPUT:return i("READ WPC_SW_JUMPER_INPUT",this.dipSwitchSetting),this.dipSwitchSetting;case g.WPC_ZEROCROSS_IRQ_CLEAR:return this.zeroCrossFlag&&(i("RESET GI ZC COUNT"),this.irqCountGI=0),e=this.zeroCrossFlag<<7|127&this.ram[t],i("READ WPC_ZEROCROSS_IRQ_CLEAR",e,this.zeroCrossFlag?"ZCF_SET":"ZCF_NOTSET"),this.zeroCrossFlag=0,e;case g.WPC_PERIPHERAL_TIMER_FIRQ_CLEAR:return i("READ WPC_PERIPHERAL_TIMER_FIRQ_CLEAR",this._firqSourceDmd),!0===this._firqSourceDmd?0:128;default:return i("R_NOT_IMPLEMENTED","0x"+t.toString(16),this.ram[t]),console.log("ASIC_READ_NOT_IMPLEMENTED","0x"+t.toString(16),this.ram[t]),this.ram[t]}}}},function(t,e,s){"use strict";t.exports={FRENCH:48,GERMAN:112,EUROPE:208,USA:0,USA2:240}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:elements:inputSwitchMatrix"),r=s(4);t.exports={getInstance:function(){return new a}};class a{constructor(){this.cabinetKeyState=0,this.cabinetKeyAutoreleaseTs=0,this.switchState=new Uint8Array(10).fill(0),this.setInputKey(24),this.activeColumn=0}setActiveColumn(t){this.activeColumn=r.findMsbBit(t),i("SET ACTIVE_COLUMN",this.activeColumn)}setCabinetKey(t){console.log("SET CABINET_KEY",t),i("SET CABINET_KEY",t),this.switchState[0]=t,this.cabinetKeyAutoreleaseTs=Date.now()}getCabinetKey(){return Date.now()-this.cabinetKeyAutoreleaseTs>100&&(this.switchState[0]=0),i("GET CABINET_KEY",this.cabinetKeyState),this.switchState[0]}setFliptronicsInput(t,e){if(!("string"==typeof t&&2===t.length)||"F"!==t[0])return void console.log("INVALID_FLIPTRONICS_INPUT_VALUE_"+t);const s=t[1]-1;i("setFliptronicsInput",t,e),!0===e?(i("SET_FLIPTRONICS_INPUT_KEY",s),this.switchState[9]|=r.setMsbBit(s)):!1===e?(i("CLEAR_FLIPTRONICS_INPUT_KEY",s),this.switchState[9]&=~r.setMsbBit(s)):(i("TOGGLE_FLIPTRONICS_INPUT_KEY",s),this.switchState[9]^=r.setMsbBit(s))}setInputKey(t=0,e){if(!Number.isInteger(t)||t<11||t>95)return console.log("INVALID INPUT_KEY",t),void i("INVALID INPUT_KEY",t,e);const s=t-1,a=Number.parseInt(s/10,10),h=Number.parseInt(s%10,10);!0===e?(i("SET_INPUT_KEY",a,h),this.switchState[a]|=r.setMsbBit(h)):!1===e?(i("CLEAR_INPUT_KEY",a,h),this.switchState[a]&=~r.setMsbBit(h)):(i("TOGGLE_INPUT_KEY",a,h),this.switchState[a]^=r.setMsbBit(h)),this.switchState[2]|=8}getActiveRow(){return i("GET ACTIVE_ROW_STATE",this.switchState[this.activeColumn]),this.switchState[this.activeColumn]}getRow(t){return i("GET ROW_STATE",this.switchState[t]),this.switchState[t]}getFliptronicsKeys(){return 255&~this.switchState[9]}clearInputKeys(){this.cabinetKeyState=0,this.switchState.fill(0)}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:elements:outputLampMatrix");t.exports={getInstance:function(t){return new r(t)}};class r{constructor(t){this.updateAfterTicks=t,this.lampState=new Uint8Array(64).fill(0),this.activeRow=0,this.activeColumn=0,this.ticks=0}_updateLampState(){if(0!==this.activeColumn)for(let t=0;t<8;t++)if(this.activeRow&1<<t)for(let e=0;e<8;e++)this.activeColumn&1<<e&&(this.lampState[e<<3|t]|=255)}executeCycle(t){this.ticks+=t,this.ticks>=this.updateAfterTicks&&(i("update lamp state"),this.ticks-=this.updateAfterTicks,this.lampState=this.lampState.map(t=>t>7?t-8:0))}setActiveRow(t){this.activeRow=t,i("SET ACTIVE_ROW",this.activeRow),this._updateLampState()}setActiveColumn(t){this.activeColumn=t,i("SET ACTIVE_COLUMN",this.activeColumn),this._updateLampState()}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:elements:outputSolenoidMatrix");t.exports={getInstance:function(t){return new r(t)}};class r{constructor(t){if(!t)throw new Error("MISSING_UPDATE_AFTER_TICKS");this.updateAfterTicks=t,this.solenoidState=new Uint8Array(40).fill(0),this.ticks=0}_updateSolenoidsPacked(t,e){for(let s=0;s<8;s++)e&1<<s&&(this.solenoidState[t+s]=255)}executeCycle(t){this.ticks+=t,this.ticks>=this.updateAfterTicks&&(i("update solenoids state"),this.ticks-=this.updateAfterTicks,this.solenoidState=this.solenoidState.map(t=>t>>>1))}writeFliptronic(t){return i("UPDATE_FLIPPER_SOLENOIDS"),this._updateSolenoidsPacked(32,t)}write(t,e){if(e<0||e>255)throw new Error("SOLENOID_MATRIX_INVALID_VALUE_"+e);switch(t){case 16353:return this._updateSolenoidsPacked(0,e);case 16355:return this._updateSolenoidsPacked(8,e);case 16354:return this._updateSolenoidsPacked(16,e);case 16352:return this._updateSolenoidsPacked(24,e);default:throw new Error("SOLENOID_MATRIX_INVALID_OFFSET_"+t.toString(16))}}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:elements:outputGeneralIllumination");t.exports={getInstance:function(t){return new r(t)}};class r{constructor(t=!1){this.generalIlluminationState=new Uint8Array(8).fill(0),this.isWpc95=t}update(t,e=0){const s=this.isWpc95?231&t|24:t;i("UPDATE_TRIAC",s,e);for(let i=0;i<5;i++)s&1<<i?this.generalIlluminationState[i]<7?this.generalIlluminationState[i]=7-e:this.generalIlluminationState[i]=7:this.generalIlluminationState[i]&&this.generalIlluminationState[i]--;this.generalIlluminationState[5]=32&s?7:0,this.generalIlluminationState[6]=64&s?7:0,this.generalIlluminationState[7]=128&s?7:0}getNormalizedState(){return this.generalIlluminationState.map(t=>31*t)}getUint8ArrayFromState(t){const e=t.map(t=>t/31);return Uint8Array.from(e)}}},function(t,e,s){"use strict";const i=[0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15];t.exports={getMemoryProtectionMask:function(t){return 65535&i[15&t]+(240&t)+16<<8}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:elements:securityPic");t.exports={getInstance:function(t){return new r(t)}};class r{constructor(t=559){const e=t+" 123456 12345 123";i("gameSerialNumber",e),this.unlockCode=new Uint8Array(3),this.unlockCodeCounter=0,this.picSerialNumber=new Uint8Array(16).fill(0),this.serialNumberScrambler=165,this.picSerialNumber[10]=18,this.picSerialNumber[2]=52;let s=100*(e[1]-"0")+10*(e[8]-"0")+(e[5]-"0");s+=5*this.picSerialNumber[10],s=7117*s+127984,this.picSerialNumber[1]=s>>16&255,this.picSerialNumber[11]=s>>8&255,this.picSerialNumber[9]=255&s,s=1e4*(e[2]-"0")+1e3*(e[18]-"0")+100*(e[0]-"0")+10*(e[9]-"0")+(e[7]-"0"),s+=2*this.picSerialNumber[10]+this.picSerialNumber[2],s=4223*s+7463513,this.picSerialNumber[7]=s>>24&255,this.picSerialNumber[12]=s>>16&255,this.picSerialNumber[0]=s>>8&255,this.picSerialNumber[8]=255&s,s=1e3*(e[19]-"0")+100*(e[4]-"0")+10*(e[6]-"0")+(e[17]-"0"),s+=this.picSerialNumber[2],s=581*s+15732,this.picSerialNumber[3]=s>>16&255,this.picSerialNumber[14]=s>>8&255,this.picSerialNumber[6]=255&s,s=1e4*("9"-e[15])+1e3*("9"-e[14])+100*("9"-e[13])+10*("9"-e[12])+("9"-e[11]),this.picSerialNumber[15]=s>>8&255,this.picSerialNumber[4]=255&s,this.originalPicSerialNumber=new Uint8Array(this.picSerialNumber),s=100*(e[0]-"0")+10*(e[1]-"0")+(e[2]-"0"),s=(s>>8&255)*(256*e[17]+e[19])+(255&s)*(256*e[18]+e[17]),this.unlockCode[0]=s>>16&255,this.unlockCode[1]=s>>8&255,this.unlockCode[2]=255&s}reset(){this.lastByteWrite=255,this.writesUntilUnlockNeeded=32,this.picSerialNumber=new Uint8Array(this.originalPicSerialNumber),i("RESET SECURITY PIC")}read(t){if(13===this.lastByteWrite)return i("R_WPC_PIC_COUNTER",this.writesUntilUnlockNeeded),this.writesUntilUnlockNeeded;if(this.lastByteWrite>=22&&this.lastByteWrite<=31){return t(this.lastByteWrite-21)}if(112==(240&this.lastByteWrite)){const t=this.picSerialNumber[15&this.lastByteWrite];return this.serialNumberScrambler=255&(this.serialNumberScrambler>>4|this.lastByteWrite<<4),this.picSerialNumber[5]=(this.picSerialNumber[5]^this.serialNumberScrambler)+this.picSerialNumber[13]&255,this.picSerialNumber[13]=255&(this.picSerialNumber[13]+this.serialNumberScrambler^this.picSerialNumber[5]),i("this.serialNumberScrambler",this.serialNumberScrambler),t}return i("UNKNOWN_READ"),0}write(t){return this.lastByteWrite=t,this.unlockCodeCounter>0?(this.unlockCode[3-this.unlockCodeCounter]===t?i("Correct code sent to pic",{sent:t,codeW:this.unlockCodeCounter,expected:this.unlockCode[3-this.unlockCodeCounter]}):i("Wrong code sent to pic",{sent:t,codeW:this.unlockCodeCounter,expected:this.unlockCode[3-this.unlockCodeCounter]}),void this.unlockCodeCounter--):0===t?(this.serialNumberScrambler=165,this.picSerialNumber[5]=this.picSerialNumber[0]^this.picSerialNumber[15],this.picSerialNumber[13]=this.picSerialNumber[2]^this.picSerialNumber[12],this.writesUntilUnlockNeeded=32,void i("W_INIT_PIC",this.serialNumberScrambler)):32===t?(i("W_WPC_PIC_UNLOCK"),void(this.unlockCodeCounter=3)):13===t?(i("W_WPC_PIC_COUNTER"),void(this.writesUntilUnlockNeeded=this.writesUntilUnlockNeeded-1&31)):void 0}getScrambler(){return this.serialNumberScrambler}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:sound-board"),r=s(28),a={WPC_LATCH_READ:12288,WPC_LATCH_WRITE:15360,WPC_SOUND_CONTROL_STATUS:16349,WPC_SOUND_DATA:16348};t.exports={getInstance:function(t){return new h(t)},OP:a};class h{constructor(t){const e=!0===t.romObject.preDcsSoundboard;this.soundSerialInterface=r.getInstance(e),this.readDataBytes=0,this.writeDataBytes=0,this.readControlBytes=0,this.writeControlBytes=0,this.resetCount=0}reset(){i("RESET_SOUNDBOARD"),this.soundSerialInterface.reset(),this.readDataBytes=0,this.writeDataBytes=0,this.readControlBytes=0,this.writeControlBytes=0,this.resetCount++}getState(){return{volume:this.soundSerialInterface.volume,readDataBytes:this.readDataBytes,writeDataBytes:this.writeDataBytes,readControlBytes:this.readControlBytes,writeControlBytes:this.writeControlBytes}}setState(t){if(!t)return!1;this.soundSerialInterface.volume=t.volume,this.readDataBytes=t.readDataBytes,this.writeDataBytes=t.writeDataBytes,this.readControlBytes=t.readControlBytes,this.writeControlBytes=t.writeControlBytes}registerSoundBoardCallback(t){if("function"!=typeof t)return console.log("ERROR: INVALID CALLBACK FUNCTION"),!1;this.soundSerialInterface.registerCallBack(t)}writeInterface(t,e){switch(t){case a.WPC_SOUND_CONTROL_STATUS:this.writeControlBytes++;this.soundSerialInterface.writeControl(e)&&this.reset();break;case a.WPC_SOUND_DATA:if(this.resetCount>20&&0===e)return this.resetCount=0,void console.log("ignore first 0 after multiple soundboard reset!");i("WRITE WPC_LATCH_WRITE",e),this.writeDataBytes++,this.soundSerialInterface.writeData(e);break;default:i("wpcemu:boards:sound-board W_NOT_IMPLEMENTED","0x"+t.toString(16),e),console.log("SND_W_NOT_IMPLEMENTED","0x"+t.toString(16),e)}}readInterface(t){switch(t){case a.WPC_SOUND_CONTROL_STATUS:{this.readControlBytes++;const t=this.soundSerialInterface.readControl();return i("READ_WPC_SOUND_CONTROL_STATUS",t),t}case a.WPC_SOUND_DATA:{this.readDataBytes++;const t=this.soundSerialInterface.readData();return i("READ WPC_LATCH_READ",t),t}default:return console.log("wpcemu:boards:sound-board R_NOT_IMPLEMENTED","0x"+t.toString(16)),i("SND_R_NOT_IMPLEMENTED","0x"+t.toString(16)),0}}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:elements:soundSerialInterface"),r=s(29);t.exports={getInstance:function(t){return new a(t)}};class a{constructor(t){this.isPreDcsSoundBoard=t,this.soundBoardCallback=()=>{},this.writeQueue=new h,this.readQueue=new h,this.volume=8,this.lastUnknownControlWrite=-1}reset(){this.writeQueue.clear(),this.readQueue.clear(),this.volume=8,this._callbackStopAllSamples(),this.lastUnknownControlWrite=-1}registerCallBack(t){this.soundBoardCallback=t}readData(){return this.readQueue.isEmpty()?(i("READ_DATA_EMPTY"),0):(i("READ_DATA"),this.readQueue.remove())}writeData(t){i("DATA_WRITE",t),this.writeQueue.insert(t),this.isPreDcsSoundBoard?this._processPreDcsSoundCommand(t):this._processDcsSoundCommand(t)}readControl(){return this.readQueue.isEmpty()?(i("READ_CONTROL_EMPTY"),255):(i("READ_CONTROL_AVAILABLE"),128)}writeControl(t){if(i("CONTROL_WRITE",t),0===t)return!0;1!==t&&t!==this.lastUnknownControlWrite&&(console.log("SND: UNKNOWN CONTROL WRITE:",t),this.lastUnknownControlWrite=t)}_processPreDcsSoundCommand(t){if(121===this.writeQueue.queue[0]){if(3!==this.writeQueue.size())return;const t=r.getRelativeVolumePreDcs(this.writeQueue.queue[1],this.writeQueue.queue[2]);return Number.isInteger(t)&&(this.volume=t,this._callbackMainVolume(this.volume),i("VOLUME_SET",this.volume)),void this.writeQueue.clear()}if(122===this.writeQueue.queue[0]){if(this.writeQueue.size()>1){const t=31232+this.writeQueue.queue[1];this._callbackPlaySample(t),this.writeQueue.clear()}}else this._callbackPlaySample(this.writeQueue.queue[0]),this.writeQueue.clear()}_processDcsSoundCommand(){if(this.writeQueue.size()<2)return;if(85===this.writeQueue.queue[0]){if(console.log("-> pendingVolumeCommand",this.writeQueue.size()),4!==this.writeQueue.size())return;if(170===this.writeQueue.queue[1]){const t=r.getRelativeVolumeDcs(this.writeQueue.queue[2],this.writeQueue.queue[3]);Number.isInteger(t)&&(this.volume=t,this._callbackMainVolume(this.volume),i("VOLUME_SET",this.volume))}else console.log("ONLY GLOBAL VOLUME SUPPORTED NOW! ;(");return void this.writeQueue.clear()}const t=this.writeQueue.queue[0]<<8|this.writeQueue.queue[1];switch(t){case 0:console.log("-> STOP ALL SAMPLES"),this._callbackStopAllSamples();break;case 992:case 993:case 994:case 995:case 996:case 997:case 998:{const e=t-992;this._callbackChannelOff(e);break}case 978:case 979:this.readQueue.insert(1);break;case 999:console.log("DCS_GET_MAIN_VERSION"),this.readQueue.insert(16);break;case 1e3:console.log("DCS_GET_MINOR_VERSION"),this.readQueue.insert(1);break;default:this._callbackPlaySample(t)}this.writeQueue.clear()}_callbackStopAllSamples(){this.soundBoardCallback({command:"STOPSOUND"})}_callbackPlaySample(t){0!==t?this.soundBoardCallback({command:"PLAYSAMPLE",id:t}):this._callbackStopAllSamples()}_callbackChannelOff(t){this.soundBoardCallback({command:"CHANNELOFF",channel:t})}_callbackMainVolume(t){this.soundBoardCallback({command:"MAINVOLUME",value:t})}}class h{constructor(){this.queue=[]}insert(t){this.queue.push(t)}remove(){return this.queue.shift()}isEmpty(){return 0===this.queue.length}clear(){this.queue=[]}size(){return this.queue.length}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:elements:soundVolumeConvert");t.exports={getRelativeVolumeDcs:function(t,e){if(t!==(255&~e))return void i("WARNING, INVALID VOLUME VALUE:",t,e);return Number.parseInt(t/8,10)},getRelativeVolumePreDcs:function(t,e){if(t!==(255&~e))return void i("WARNING, INVALID VOLUME VALUE:",t,e);return Number.parseInt(t,10)}}},function(t,e,s){"use strict";const i=16320,r=16321,a=16322,h=16323,o=16324,n=16325,c=16326,u=16341;t.exports={getInstance:function(){return new d}};class d{constructor(){this.ram=new Uint8Array(32).fill(0)}write(t,e){const s=t-i;switch(this.ram[s]=e,t){case i:case r:case a:case h:case o:case n:case c:case u:break;default:console.log("IO W_NOT_IMPLEMENTED","0x"+t.toString(16),e)}}read(t){const e=t-i;switch(t){case c:return 255;case i:case r:case a:case h:case o:case n:case u:break;default:console.log("IO R_NOT_IMPLEMENTED","0x"+t.toString(16))}return this.ram[e]}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:memory-handler"),r=s(32);t.exports={getInstance:function(t,e){return new a(t,e)}};class a{constructor(t,e){this.checksumPositions=t&&t.checksum&&t.checksum.filter(t=>Number.isInteger(t.dataStartOffset)&&Number.isInteger(t.dataEndOffset)&&Number.isInteger(t.checksumOffset)),this.ram=e,i("MEMORY_WRITE_HANDLER_INITIALIZED")}writeMemory(t,e){Array.isArray(e)?e.forEach(e=>{this.ram[t++]=e}):"string"==typeof e?e.split("").forEach(e=>{this.ram[t++]=e}):this.ram[t]=e;const s=this.checksumPositions&&this._needsChecksumUpdate(t);if(s){const t=this.ram.subarray(s.dataStartOffset,s.dataEndOffset+1),e=r.checksum16(t);this.ram[s.checksumOffset]=e>>>8&255,this.ram[s.checksumOffset+1]=255&e}}_needsChecksumUpdate(t){return this.checksumPositions.find(e=>t>=e.dataStartOffset&&t<=e.dataEndOffset)}}},function(t,e,s){"use strict";t.exports={checksum16:function(t){const e=t.reduce((t,e)=>t+e,0);return 65535-e}}},function(t,e,s){"use strict";t.exports={getInstance:function(){return new i}};class i{constructor(){this.patch=new Map}addPatch(t,e,s=!1){this.patch.set(t,{memoryOffset:t,value:e,volatile:s})}removePatch(t){this.patch.delete(t)}removeVolatileEntries(){[...this.patch.values()].filter(t=>t.volatile).forEach(t=>this.patch.delete(t.memoryOffset))}hasPatch(t){return this.patch.get(t)}applyPatchesToExposedMemory(t){const e=new Uint8Array(t);return this.patch.forEach((t,s)=>{s<16384&&(e[s]=t.value)}),e}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:elements:memoryPatchGameId");t.exports={run:function(t,e){return i("add memorypatch",e),t.addPatch(e,20),t.addPatch(e+1,99),t}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:elements:memoryPatchSkipBootCheck");t.exports={run:function(t){return i("add memorypatch"),t.addPatch(65516,0),t.addPatch(65517,255),t}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:dmd"),r=s(37),a=s(38),h=s(39),o={FREEWPC_DEBUG_CONTROL_PORT:15713,WPC_SERIAL_CONTROL_PORT:15974,WPC95_PRINTER_DATA:16304,WPC95_PRINTER_BAUD:16305,WPC95_PRINTER_ADDR:16307,WPC95_PRINTER_STATUS:16309,WPC95_PRINTER_PRESENCE:16311,WPC95_DMD_PAGE3000:16313,WPC95_DMD_PAGE3200:16312,WPC95_DMD_PAGE3400:16315,WPC95_DMD_PAGE3600:16314,WPC_DMD_HIGH_PAGE:16316,WPC_DMD_SCANLINE:16317,WPC_DMD_LOW_PAGE:16318,WPC_DMD_ACTIVE_PAGE:16319,WPC_ALPHA_POS:16363,WPC_ALPHA_ROW1_A:16364,WPC_ALPHA_ROW1_B:16365,WPC_ALPHA_ROW2_A:16366,WPC_ALPHA_ROW2_B:16367},n=[];Object.keys(o).forEach(t=>{n[o[t]]=t}),t.exports={getInstance:function(t){return new c(t)},OP:o};class c{constructor(t){this.interruptCallback=t.interruptCallback,this.ram=t.ram,this.hasAlphanumericDisplay=t.hasAlphanumericDisplay,this.outputDmdDisplay=a.getInstance(512),this.outputAlphaDisplay=h.getInstance(512)}reset(){console.log("RESET_DISPLAY_BOARD")}getState(){return this.hasAlphanumericDisplay?this.outputAlphaDisplay.getState():this.outputDmdDisplay.getState()}setState(t){return this.hasAlphanumericDisplay?this.outputAlphaDisplay.setState(t):this.outputDmdDisplay.setState(t)}executeCycle(t){if(this.hasAlphanumericDisplay)return void this.outputAlphaDisplay.executeCycle(t);const e=this.outputDmdDisplay.executeCycle(t);e&&e.requestFIRQ&&e.scanline===this.ram[o.WPC_DMD_SCANLINE]&&(this.interruptCallback.firqFromDmd(),this.outputDmdDisplay.requestFIRQ=!1)}write(t,e){const s=r.getAddress(t);if(s.subsystem!==r.SUBSYSTEM_DMD_VIDEORAM)switch(this.ram[t]=e,t){case o.WPC95_PRINTER_DATA:case o.WPC95_PRINTER_BAUD:case o.WPC95_PRINTER_ADDR:case o.WPC95_PRINTER_STATUS:case o.WPC95_PRINTER_PRESENCE:i("WRITE_IGNORED",n[t],e);break;case o.WPC_DMD_SCANLINE:i("WRITE",n[t],e),this.outputDmdDisplay.requestFIRQ=!0;break;case o.WPC_DMD_ACTIVE_PAGE:i("WRITE",n[t],e),this.outputDmdDisplay.setNextActivePage(e);break;case o.WPC_DMD_LOW_PAGE:this.outputDmdDisplay.selectDmdPage(0,e);break;case o.WPC_DMD_HIGH_PAGE:this.outputDmdDisplay.selectDmdPage(1,e);break;case o.WPC95_DMD_PAGE3000:this.outputDmdDisplay.selectDmdPage(2,e);break;case o.WPC95_DMD_PAGE3200:this.outputDmdDisplay.selectDmdPage(3,e);break;case o.WPC95_DMD_PAGE3400:this.outputDmdDisplay.selectDmdPage(4,e);break;case o.WPC95_DMD_PAGE3600:this.outputDmdDisplay.selectDmdPage(5,e);break;case o.WPC_ALPHA_POS:this.outputAlphaDisplay.setSegmentColumn(e);break;case o.WPC_ALPHA_ROW1_A:this.outputAlphaDisplay.setRow1(!0,e);break;case o.WPC_ALPHA_ROW1_B:this.outputAlphaDisplay.setRow1(!1,e);break;case o.WPC_ALPHA_ROW2_A:this.outputAlphaDisplay.setRow2(!0,e);break;case o.WPC_ALPHA_ROW2_B:this.outputAlphaDisplay.setRow2(!1,e);break;default:i("W_NOT_IMPLEMENTED","0x"+t.toString(16),e),console.log("DMD W_NOT_IMPLEMENTED","0x"+t.toString(16),e)}else this.outputDmdDisplay.writeVideoRam(s.bank,s.offset,e)}read(t){const e=r.getAddress(t);if(e.subsystem===r.SUBSYSTEM_DMD_VIDEORAM)return this.outputDmdDisplay.readVideoRam(e.bank,e.offset);switch(t){case o.WPC95_PRINTER_DATA:case o.WPC95_PRINTER_BAUD:case o.WPC95_PRINTER_ADDR:case o.WPC95_PRINTER_STATUS:case o.WPC95_PRINTER_PRESENCE:case o.FREEWPC_DEBUG_CONTROL_PORT:case o.WPC_SERIAL_CONTROL_PORT:return i("READ",n[t],0),0;case o.WPC_ALPHA_POS:case o.WPC_ALPHA_ROW1_A:case o.WPC_ALPHA_ROW1_B:case o.WPC_ALPHA_ROW2_A:case o.WPC_ALPHA_ROW2_B:return i("READ",n[t]),this.ram[t];case o.WPC_DMD_SCANLINE:return i("READ",n[t],this.scanline),this.ram[t];default:return i("R_NOT_IMPLEMENTED","0x"+t.toString(16)),console.log("DMD R_NOT_IMPLEMENTED","0x"+t.toString(16)),0}}}},function(t,e,s){"use strict";function i(t,e,s){return{offset:t,subsystem:e,bank:s}}t.exports={getAddress:function(t){if(void 0===t)throw new Error("DMD_GET_ADDRESS_UNDEFINED");if(t<12288)throw new Error("INVALID_DMD_ADDRESSRANGE_"+t);if((t&=65535)<12800)return i(t-12288,"videoram",2);if(t<13312)return i(t-12800,"videoram",3);if(t<13824)return i(t-13312,"videoram",4);if(t<14336)return i(t-13824,"videoram",5);if(t<14848)return i(t-14336,"videoram",0);if(t<15360)return i(t-14848,"videoram",1);return i(t,"command")},SUBSYSTEM_DMD_VIDEORAM:"videoram",SUBSYSTEM_CMD:"command",MEMORY_ADDR_DMD_PAGE3000:12288,MEMORY_ADDR_DMD_PAGE3200:12800,MEMORY_ADDR_DMD_PAGE3400:13312,MEMORY_ADDR_DMD_PAGE3600:13824,MEMORY_ADDR_DMD_PAGE_LOW:14336,MEMORY_ADDR_DMD_PAGE_HIGH:14848}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:elements:outputDmdDisplay"),r=s(2),a=s(4);t.exports={getInstance:function(t){return new h(t)}};class h{constructor(t){this.dmdPageSize=t,this.shadedVideoBuffer=new Uint8Array(3*t).fill(0),this.shadedVideoBufferLatched=new Uint8Array(3*t).fill(0),this.videoRam=new Uint8Array(16*t).fill(0),this.dmdPageMapping=[0,0,0,0,0,0],this.scanline=0,this.activePage=0,this.nextActivePage=void 0,this.videoOutputPointer=0,this.requestFIRQ=!0,this.ticksUpdateDmd=0}executeCycle(t){if(this.ticksUpdateDmd+=t,this.ticksUpdateDmd>=r.CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS)return this.ticksUpdateDmd-=r.CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS,this._copyScanline(),{requestFIRQ:this.requestFIRQ,scanline:this.scanline}}getState(){return{scanline:this.scanline,activepage:this.activePage,nextActivePage:this.nextActivePage,dmdPageMapping:this.dmdPageMapping,dmdShadedBuffer:this._getShadedOutputVideoFrame(),requestFIRQ:this.requestFIRQ,videoRam:this.videoRam,videoOutputBuffer:this.shadedVideoBuffer,videoOutputPointer:this.videoOutputPointer,ticksUpdateDmd:this.ticksUpdateDmd}}setState(t){if(!t)return!1;this.scanline=t.scanline,this.activepage=t.activepage,this.dmdPageMapping=t.dmdPageMapping,this.requestFIRQ=!0===t.requestFIRQ,this.videoOutputPointer=t.videoOutputPointer,this.ticksUpdateDmd=t.ticksUpdateDmd,this.setNextActivePage(t.nextActivePage),"object"==typeof t.videoRam&&(this.videoRam=Uint8Array.from(t.videoRam))}selectDmdPage(t,e){const s=15&e;i("_selectDmdPage %o",{bank:t,page:s}),this.dmdPageMapping[t]=s}setNextActivePage(t){this.nextActivePage=15&t}_getVideoRamOffset(t,e){return this.dmdPageMapping[t]*this.dmdPageSize+e}writeVideoRam(t,e,s){const i=this._getVideoRamOffset(t,e);this.videoRam[i]=s}readVideoRam(t,e){const s=this._getVideoRamOffset(t,e);return this.videoRam[s]}_copyScanline(){const t=this.activePage*this.dmdPageSize+16*this.scanline,e=this.videoOutputPointer*this.dmdPageSize+16*this.scanline;for(let s=0;s<16;s++)this.shadedVideoBuffer[e+s]=this.videoRam[t+s];this.scanline=this.scanline+1&31,0===this.scanline&&(this.videoOutputPointer=(this.videoOutputPointer+1)%3,this.shadedVideoBufferLatched=new Uint8Array(this.shadedVideoBuffer),Number.isInteger(this.nextActivePage)&&(this.activePage=this.nextActivePage,this.nextActivePage=void 0))}_getShadedOutputVideoFrame(){const t=this.dmdPageSize,e=2*this.dmdPageSize,s=new Uint8Array(8*this.dmdPageSize).fill(0);let i=0,r=0;for(let h=0;h<32;h++)for(let o=0;o<16;o++){for(let h=0;h<8;h++){const o=a.setMsbBit(h),n=((this.shadedVideoBufferLatched[0+r]&o)>0?1:0)+((this.shadedVideoBufferLatched[t+r]&o)>0?1:0)+((this.shadedVideoBufferLatched[e+r]&o)>0?1:0);s[i++]=n}r++}return s}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:elements:outputAlphaDisplay"),r=s(2);t.exports={getInstance:function(t){return new a(t)}};class a{constructor(t){this.dmdPageSize=8*t,this.segmentColumn=0,this.ticksUpdateAlpha=0,this.displayData=new Uint16Array(32).fill(0),this.displayDataLatched=new Uint16Array(32).fill(0)}getState(){return{scanline:this.segmentColumn,dmdShadedBuffer:this._getShadedOutputVideoFrame(),dmdPageMapping:[0,0]}}setState(t){if(!t)return!1;this.segmentColumn=t.scanline}setSegmentColumn(t){this.segmentColumn=15&t,i("setSegmentColumn",this.segmentColumn)}executeCycle(t){this.ticksUpdateAlpha+=t,this.ticksUpdateAlpha>=r.UPDATE_ALPHANUMERIC_DISPLAY_TICKS&&(this.displayDataLatched=Uint16Array.from(this.displayData),this.displayData.fill(0),this.ticksUpdateAlpha=0)}_update(t,e,s){this.displayData[this.segmentColumn+t]|=e?s<<8&65280:255&s}setRow1(t,e){this._update(0,t,e)}setRow2(t,e){this._update(16,t,e)}_drawChar(t,e,s){let i;256&s&&(t[e]=3,t[e+1]=3,t[e+2]=3,t[e+3]=3,t[e+4]=3),2048&s&&(i=1280+e,t[i]=3,t[i+1]=3,t[i+2]=3,t[i+3]=3,t[i+4]=3),32768&s&&(t[1280+e+6]=3),128&s&&(t[1408+e+6]=2),16384&s&&(i=640+e,t[i]=3,t[i+1]=3,t[i+2]=3),8&s&&(i=640+e+2,t[i]=3,t[i+1]=3,t[i+2]=3),2&s&&(i=e+2,t[i]=3,t[i+128]=3,t[i+256]=3,t[i+384]=3,t[i+512]=3,t[i+640]=3),32&s&&(i=640+e+2,t[i]=3,t[i+128]=3,t[i+256]=3,t[i+384]=3,t[i+512]=3,t[i+640]=3),8192&s&&(t[e]=3,t[e+128]=3,t[e+256]=3,t[e+384]=3,t[e+512]=3,t[e+640]=3),4096&s&&(i=640+e,t[i]=3,t[i+128]=3,t[i+256]=3,t[i+384]=3,t[i+512]=3,t[i+640]=3),512&s&&(t[4+e]=3,t[4+e+128]=3,t[4+e+256]=3,t[4+e+384]=3,t[4+e+512]=3,t[4+e+640]=3),1024&s&&(i=644+e,t[i]=3,t[i+128]=3,t[i+256]=3,t[i+384]=3,t[i+512]=3,t[i+640]=3),4&s&&(t[642+e]=3,t[514+e]=3,t[387+e]=3,t[259+e]=3,t[132+e]=3,t[4+e]=3),1&s&&(t[642+e]=3,t[514+e]=3,t[385+e]=3,t[257+e]=3,t[128+e]=3,t[0+e]=3),16&s&&(t[642+e]=3,t[770+e]=3,t[899+e]=3,t[1027+e]=3,t[1156+e]=3,t[1284+e]=3),64&s&&(t[642+e]=3,t[770+e]=3,t[897+e]=3,t[1025+e]=3,t[1152+e]=3,t[1280+e]=3)}_getShadedOutputVideoFrame(){const t=new Uint8Array(this.dmdPageSize).fill(0);for(let e=0;e<16;e++)this._drawChar(t,8*e,this.displayDataLatched[e]);for(let e=16;e<32;e++)this._drawChar(t,2048+8*e,this.displayDataLatched[e]);return t}}},function(t,e,s){"use strict";const i=s(0)("wpcemu:boards:up:cpu6809:"),r=[6,0,0,6,6,0,6,6,6,6,6,0,6,6,3,6,1,1,2,2,0,0,5,9,0,2,3,0,3,2,8,7,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,5,5,5,5,0,5,3,6,21,11,0,19,2,0,0,2,2,0,2,2,2,2,2,0,2,2,0,2,2,0,0,2,2,0,2,2,2,2,2,0,2,2,0,2,6,0,0,6,6,0,6,6,6,6,6,0,6,6,3,6,7,0,0,7,7,0,7,7,7,7,7,0,7,7,4,7,2,2,2,4,2,2,2,0,2,2,2,2,4,7,3,0,4,4,4,6,4,4,4,4,4,4,4,4,6,7,5,5,4,4,4,6,4,4,4,4,4,4,4,4,6,7,5,5,5,5,5,7,5,5,5,5,5,5,5,5,7,8,6,6,2,2,2,4,2,2,2,0,2,2,2,2,3,0,3,0,4,4,4,6,4,4,4,4,4,4,4,4,5,5,5,5,4,4,4,6,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,7,5,5,5,5,5,5,5,5,6,6,6,6],a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,5,0,4,0,0,0,0,7,0,0,0,0,0,0,0,0,7,0,6,6,0,0,0,7,0,0,0,0,0,0,0,0,7,0,6,6,0,0,0,8,0,0,0,0,0,0,0,0,8,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],h=[4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8];t.exports={getInstance:function(t,e){return new o(t,e)}};class o{constructor(t,e){i("INITIALIZE CPU"),this.memoryWriteFunction=t,this.memoryReadFunction=e,this.tickCount=0,this.irqPending=!1,this.firqPending=!1,this.missedIRQ=0,this.missedFIRQ=0,this.irqCount=0,this.firqCount=0,this.nmiCount=0,this.regA=0,this.regB=0,this.regX=0,this.regY=0,this.regU=0,this.regS=0,this.regCC=0,this.regPC=0,this.regDP=0}setV8(t,e,s){this.regCC|=(128&(t^e^s^s>>1))>>6}setV16(t,e,s){this.regCC|=(32768&(t^e^s^s>>1))>>14}getD(){return(this.regA<<8)+this.regB}setD(t){this.regA=t>>8&255,this.regB=255&t}PUSHB(t){this.regS=this.regS-1&65535,this.memoryWriteFunction(this.regS,255&t)}PUSHW(t){this.regS=this.regS-1&65535,this.memoryWriteFunction(this.regS,255&t),this.regS=this.regS-1&65535,this.memoryWriteFunction(this.regS,t>>8&255)}PUSHBU(t){this.regU=this.regU-1&65535,this.memoryWriteFunction(this.regU,255&t)}PUSHWU(t){this.regU=this.regU-1&65535,this.memoryWriteFunction(this.regU,255&t),this.regU=this.regU-1&65535,this.memoryWriteFunction(this.regU,t>>8&255)}PULLB(){return this.memoryReadFunction(this.regS++)}PULLW(){return(this.memoryReadFunction(this.regS++)<<8)+this.memoryReadFunction(this.regS++)}PULLBU(){return this.memoryReadFunction(this.regU++)}PULLWU(){return(this.memoryReadFunction(this.regU++)<<8)+this.memoryReadFunction(this.regU++)}PSHS(t){let e=0;128&t&&(this.PUSHW(this.regPC),e+=2),64&t&&(this.PUSHW(this.regU),e+=2),32&t&&(this.PUSHW(this.regY),e+=2),16&t&&(this.PUSHW(this.regX),e+=2),8&t&&(this.PUSHB(this.regDP),e++),4&t&&(this.PUSHB(this.regB),e++),2&t&&(this.PUSHB(this.regA),e++),1&t&&(this.PUSHB(this.regCC),e++),this.tickCount+=e}PSHU(t){let e=0;128&t&&(this.PUSHWU(this.regPC),e+=2),64&t&&(this.PUSHWU(this.regS),e+=2),32&t&&(this.PUSHWU(this.regY),e+=2),16&t&&(this.PUSHWU(this.regX),e+=2),8&t&&(this.PUSHBU(this.regDP),e++),4&t&&(this.PUSHBU(this.regB),e++),2&t&&(this.PUSHBU(this.regA),e++),1&t&&(this.PUSHBU(this.regCC),e++),this.tickCount+=e}PULS(t){let e=0;1&t&&(this.regCC=this.PULLB(),e++),2&t&&(this.regA=this.PULLB(),e++),4&t&&(this.regB=this.PULLB(),e++),8&t&&(this.regDP=this.PULLB(),e++),16&t&&(this.regX=this.PULLW(),e+=2),32&t&&(this.regY=this.PULLW(),e+=2),64&t&&(this.regU=this.PULLW(),e+=2),128&t&&(this.regPC=this.PULLW(),e+=2),this.tickCount+=e}PULU(t){let e=0;1&t&&(this.regCC=this.PULLBU(),e++),2&t&&(this.regA=this.PULLBU(),e++),4&t&&(this.regB=this.PULLBU(),e++),8&t&&(this.regDP=this.PULLBU(),e++),16&t&&(this.regX=this.PULLWU(),e+=2),32&t&&(this.regY=this.PULLWU(),e+=2),64&t&&(this.regS=this.PULLWU(),e+=2),128&t&&(this.regPC=this.PULLWU(),e+=2),this.tickCount+=e}getPostByteRegister(t){switch(15&t){case 0:return this.getD();case 1:return this.regX;case 2:return this.regY;case 3:return this.regU;case 4:return this.regS;case 5:return this.regPC;case 8:return this.regA;case 9:return this.regB;case 10:return this.regCC;case 11:return this.regDP;default:throw new Error("getPBR_INVALID_"+t)}}setPostByteRegister(t,e){switch(15&t){case 0:return void this.setD(e);case 1:return void(this.regX=e);case 2:return void(this.regY=e);case 3:return void(this.regU=e);case 4:return void(this.regS=e);case 5:return void(this.regPC=e);case 8:return void(this.regA=255&e);case 9:return void(this.regB=255&e);case 10:return void(this.regCC=255&e);case 11:return void(this.regDP=255&e);default:throw new Error("setPBR_INVALID_"+t)}}TFREXG(t,e){let s=136&t;if(128===s||8===s)throw new Error("TFREXG_ERROR_MIXING_8_AND_16BIT_REGISTER!");s=this.getPostByteRegister(t>>4),e&&this.setPostByteRegister(t>>4,this.getPostByteRegister(t)),this.setPostByteRegister(t,s)}signed5bit(t){return t>15?t-32:t}signed(t){return t>127?t-256:t}signed16(t){return t>32767?t-65536:t}fetch(){return this.memoryReadFunction(this.regPC++)}fetch16(){return(this.memoryReadFunction(this.regPC++)<<8)+this.memoryReadFunction(this.regPC++)}ReadWord(t){return(this.memoryReadFunction(t)<<8)+this.memoryReadFunction(t+1&65535)}WriteWord(t,e){this.memoryWriteFunction(t,e>>8&255),this.memoryWriteFunction(t+1&65535,255&e)}PostByte(){const t=this.fetch();let e;switch(96&t){case 0:e=this.regX;break;case 32:e=this.regY;break;case 64:e=this.regU;break;case 96:e=this.regS;break;default:throw new Error("INVALID_ADDRESS_PB")}let s=null,i=null;if(128&t){switch(15&t){case 0:i=e,s=e+1,this.tickCount+=2;break;case 1:i=e,s=e+2,this.tickCount+=3;break;case 2:s=e-1,i=s,this.tickCount+=2;break;case 3:s=e-2,i=s,this.tickCount+=3;break;case 4:i=e;break;case 5:i=e+this.signed(this.regB),this.tickCount+=1;break;case 6:i=e+this.signed(this.regA),this.tickCount+=1;break;case 8:i=e+this.signed(this.fetch()),this.tickCount+=1;break;case 9:i=e+this.signed16(this.fetch16()),this.tickCount+=4;break;case 11:i=e+this.getD(),this.tickCount+=4;break;case 12:{const t=this.signed(this.fetch());i=this.regPC+t,this.tickCount+=1;break}case 13:{const t=this.signed16(this.fetch16());i=this.regPC+t,this.tickCount+=5;break}case 15:i=this.fetch16(),this.tickCount+=5;break;default:throw new Error("INVALID_ADDRESS_MODE_"+(15&t))}i&=65535,16&t&&(i=this.ReadWord(i),this.tickCount+=3)}else{i=e+this.signed5bit(31&t),this.tickCount+=1}if(null!==s)switch(s&=65535,96&t){case 0:this.regX=s;break;case 32:this.regY=s;break;case 64:this.regU=s;break;case 96:this.regS=s;break;default:throw new Error("PB_INVALID_XCHG_VALUE_"+t)}return 65535&i}flagsNZ16(t){this.regCC&=-13,0===t&&(this.regCC|=4),32768&t&&(this.regCC|=8)}oINC(t){return t=t+1&255,this.regCC&=-15,this.regCC|=h[t],128===t&&(this.regCC|=2),t}oDEC(t){return t=t-1&255,this.regCC&=-15,this.regCC|=h[t],127===t&&(this.regCC|=2),t}oSUB(t,e){let s=t-e;return this.regCC&=-16,256&s&&(this.regCC|=1),this.setV8(t,e,s),s&=255,this.regCC|=h[s],s}oSUB16(t,e){let s=t-e;return this.regCC&=-16,32768&s&&(this.regCC|=8),65536&s&&(this.regCC|=1),this.setV16(t,e,s),s&=65535,0===s&&(this.regCC|=4),s}oADD(t,e){let s=t+e;return this.regCC&=-48,256&s&&(this.regCC|=1),this.setV8(t,e,s),16&(s^t^e)&&(this.regCC|=32),s&=255,this.regCC|=h[s],s}oADD16(t,e){let s=t+e;return this.regCC&=-16,32768&s&&(this.regCC|=8),65536&s&&(this.regCC|=1),this.setV16(t,e,s),s&=65535,0===s&&(this.regCC|=4),s}oADC(t,e){let s=t+e+(1&this.regCC);return this.regCC&=-48,256&s&&(this.regCC|=1),this.setV8(t,e,s),16&(s^t^e)&&(this.regCC|=32),s&=255,this.regCC|=h[s],s}oSBC(t,e){let s=t-e-(1&this.regCC);return this.regCC&=-16,256&s&&(this.regCC|=1),this.setV8(t,e,s),s&=255,this.regCC|=h[s],s}oCMP(t,e){let s=t-e;this.regCC&=-16,256&s&&(this.regCC|=1),this.setV8(t,e,s),s&=255,this.regCC|=h[s]}oCMP16(t,e){const s=t-e;this.regCC&=-16,0==(65535&s)&&(this.regCC|=4),32768&s&&(this.regCC|=8),65536&s&&(this.regCC|=1),this.setV16(t,e,s)}oNEG(t){return this.regCC&=-16,128===(t=0-t&255)&&(this.regCC|=2),0===t&&(this.regCC|=4),128&t&&(this.regCC|=9),t}oLSR(t){return this.regCC&=-14,1&t&&(this.regCC|=1),0===(t>>=1)&&(this.regCC|=4),t}oASR(t){return this.regCC&=-14,1&t&&(this.regCC|=1),t=128&t|t>>1,t&=255,this.regCC|=h[t],t}oASL(t){const e=t;return this.regCC&=-16,128&t&&(this.regCC|=1),128&((t<<=1)^e)&&(this.regCC|=2),t&=255,this.regCC|=h[t],t}oROL(t){const e=t,s=1&this.regCC;return this.regCC&=-16,128&t&&(this.regCC|=1),128&((t=t<<1|s)^e)&&(this.regCC|=2),t&=255,this.regCC|=h[t],t}oROR(t){const e=1&this.regCC;return this.regCC&=-14,1&t&&(this.regCC|=1),t=t>>1|e<<7,t&=255,this.regCC|=h[t],t}oEOR(t,e){return this.regCC&=-15,t^=e,t&=255,this.regCC|=h[t],t}oOR(t,e){return this.regCC&=-15,t|=e,t&=255,this.regCC|=h[t],t}oAND(t,e){return this.regCC&=-15,t&=e,t&=255,this.regCC|=h[t],t}oCOM(t){return this.regCC&=-15,t^=255,t&=255,this.regCC|=h[t],this.regCC|=1,t}dpadd(){return(this.regDP<<8)+this.fetch()}step(){const t=this.tickCount;if(this.firqPending){if(0==(64&this.regCC))return this.firqPending=!1,this.firqCount++,this._executeFirq(),this.tickCount-t;this.missedFIRQ++}if(this.irqPending){if(0==(16&this.regCC))return this.irqPending=!1,this.irqCount++,this._executeIrq(),this.tickCount-t;this.missedIRQ++}let e=null,s=null,o=this.fetch();switch(this.tickCount+=r[o],o){case 0:e=this.dpadd(),this.memoryWriteFunction(e,this.oNEG(this.memoryReadFunction(e)));break;case 3:e=this.dpadd(),this.memoryWriteFunction(e,this.oCOM(this.memoryReadFunction(e)));break;case 4:e=this.dpadd(),this.memoryWriteFunction(e,this.oLSR(this.memoryReadFunction(e)));break;case 6:e=this.dpadd(),this.memoryWriteFunction(e,this.oROR(this.memoryReadFunction(e)));break;case 7:e=this.dpadd(),this.memoryWriteFunction(e,this.oASR(this.memoryReadFunction(e)));break;case 8:e=this.dpadd(),this.memoryWriteFunction(e,this.oASL(this.memoryReadFunction(e)));break;case 9:e=this.dpadd(),this.memoryWriteFunction(e,this.oROL(this.memoryReadFunction(e)));break;case 10:e=this.dpadd(),this.memoryWriteFunction(e,this.oDEC(this.memoryReadFunction(e)));break;case 12:e=this.dpadd(),this.memoryWriteFunction(e,this.oINC(this.memoryReadFunction(e)));break;case 13:e=this.dpadd(),s=this.memoryReadFunction(e),this.regCC&=-15,this.regCC|=h[s];break;case 14:e=this.dpadd(),this.regPC=e;break;case 15:e=this.dpadd(),this.memoryWriteFunction(e,0),this.regCC&=-12,this.regCC|=4;break;case 18:break;case 19:console.log("SYNC is broken!");break;case 22:e=this.fetch16(),this.regPC+=e;break;case 23:e=this.fetch16(),this.PUSHW(this.regPC),this.regPC+=e;break;case 25:{let t=0;const s=240&this.regA,i=15&this.regA;(i>9||32&this.regCC)&&(t|=6),s>128&&i>9&&(t|=96),(s>144||1&this.regCC)&&(t|=96),e=t+this.regA,this.regCC&=-16,256&e&&(this.regCC|=1),this.regA=255&e,this.regCC|=h[this.regA];break}case 26:this.regCC|=this.fetch();break;case 28:this.regCC&=this.fetch();break;case 29:this.regA=128&this.regB?255:0,this.flagsNZ16(this.getD());break;case 30:s=this.fetch(),this.TFREXG(s,!0);break;case 31:s=this.fetch(),this.TFREXG(s,!1);break;case 32:e=this.signed(this.fetch()),this.regPC+=e;break;case 33:e=this.signed(this.fetch());break;case 34:e=this.signed(this.fetch()),5&this.regCC||(this.regPC+=e);break;case 35:e=this.signed(this.fetch()),5&this.regCC&&(this.regPC+=e);break;case 36:e=this.signed(this.fetch()),1&this.regCC||(this.regPC+=e);break;case 37:e=this.signed(this.fetch()),1&this.regCC&&(this.regPC+=e);break;case 38:e=this.signed(this.fetch()),4&this.regCC||(this.regPC+=e);break;case 39:e=this.signed(this.fetch()),4&this.regCC&&(this.regPC+=e);break;case 40:e=this.signed(this.fetch()),2&this.regCC||(this.regPC+=e);break;case 41:e=this.signed(this.fetch()),2&this.regCC&&(this.regPC+=e);break;case 42:e=this.signed(this.fetch()),8&this.regCC||(this.regPC+=e);break;case 43:e=this.signed(this.fetch()),8&this.regCC&&(this.regPC+=e);break;case 44:e=this.signed(this.fetch()),8&this.regCC^(2&this.regCC)<<2||(this.regPC+=e);break;case 45:e=this.signed(this.fetch()),8&this.regCC^(2&this.regCC)<<2&&(this.regPC+=e);break;case 46:e=this.signed(this.fetch()),8&this.regCC^(2&this.regCC)<<2||4&this.regCC||(this.regPC+=e);break;case 47:e=this.signed(this.fetch()),(8&this.regCC^(2&this.regCC)<<2||4&this.regCC)&&(this.regPC+=e);break;case 48:this.regX=this.PostByte(),this.regCC&=-5,0===this.regX&&(this.regCC|=4);break;case 49:this.regY=this.PostByte(),this.regCC&=-5,0===this.regY&&(this.regCC|=4);break;case 50:this.regS=this.PostByte();break;case 51:this.regU=this.PostByte();break;case 52:this.PSHS(this.fetch());break;case 53:this.PULS(this.fetch());break;case 54:this.PSHU(this.fetch());break;case 55:this.PULU(this.fetch());break;case 57:this.regPC=this.PULLW();break;case 58:this.regX+=this.regB;break;case 59:this.regCC=this.PULLB(),i("RTI",128&this.regCC,this.tickCount),128&this.regCC&&(this.tickCount+=9,this.regA=this.PULLB(),this.regB=this.PULLB(),this.regDP=this.PULLB(),this.regX=this.PULLW(),this.regY=this.PULLW(),this.regU=this.PULLW()),this.regPC=this.PULLW();break;case 60:console.log("CWAI is broken!"),this.regCC&=this.fetch();break;case 61:e=this.regA*this.regB,0===e?this.regCC|=4:this.regCC&=-5,128&e?this.regCC|=1:this.regCC&=-2,this.setD(e);break;case 63:console.log("SWI is untested!"),this.regCC|=128,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regCC|=80,this.regPC=this.ReadWord(65530);break;case 64:this.regA=this.oNEG(this.regA);break;case 67:this.regA=this.oCOM(this.regA);break;case 68:this.regA=this.oLSR(this.regA);break;case 70:this.regA=this.oROR(this.regA);break;case 71:this.regA=this.oASR(this.regA);break;case 72:this.regA=this.oASL(this.regA);break;case 73:this.regA=this.oROL(this.regA);break;case 74:this.regA=this.oDEC(this.regA);break;case 76:this.regA=this.oINC(this.regA);break;case 77:this.regCC&=-15,this.regCC|=h[255&this.regA];break;case 79:this.regA=0,this.regCC&=-12,this.regCC|=4;break;case 80:this.regB=this.oNEG(this.regB);break;case 83:this.regB=this.oCOM(this.regB);break;case 84:this.regB=this.oLSR(this.regB);break;case 86:this.regB=this.oROR(this.regB);break;case 87:this.regB=this.oASR(this.regB);break;case 88:this.regB=this.oASL(this.regB);break;case 89:this.regB=this.oROL(this.regB);break;case 90:this.regB=this.oDEC(this.regB);break;case 92:this.regB=this.oINC(this.regB);break;case 93:this.regCC&=-15,this.regCC|=h[255&this.regB];break;case 95:this.regB=0,this.regCC&=-12,this.regCC|=4;break;case 96:e=this.PostByte(),this.memoryWriteFunction(e,this.oNEG(this.memoryReadFunction(e)));break;case 99:e=this.PostByte(),this.memoryWriteFunction(e,this.oCOM(this.memoryReadFunction(e)));break;case 100:e=this.PostByte(),this.memoryWriteFunction(e,this.oLSR(this.memoryReadFunction(e)));break;case 102:e=this.PostByte(),this.memoryWriteFunction(e,this.oROR(this.memoryReadFunction(e)));break;case 103:e=this.PostByte(),this.memoryWriteFunction(e,this.oASR(this.memoryReadFunction(e)));break;case 104:e=this.PostByte(),this.memoryWriteFunction(e,this.oASL(this.memoryReadFunction(e)));break;case 105:e=this.PostByte(),this.memoryWriteFunction(e,this.oROL(this.memoryReadFunction(e)));break;case 106:e=this.PostByte(),this.memoryWriteFunction(e,this.oDEC(this.memoryReadFunction(e)));break;case 108:e=this.PostByte(),this.memoryWriteFunction(e,this.oINC(this.memoryReadFunction(e)));break;case 109:e=this.PostByte(),s=this.memoryReadFunction(e),this.regCC&=-15,this.regCC|=h[s];break;case 110:e=this.PostByte(),this.regPC=e;break;case 111:e=this.PostByte(),this.memoryWriteFunction(e,0),this.regCC&=-12,this.regCC|=4;break;case 112:e=this.fetch16(),this.memoryWriteFunction(e,this.oNEG(this.memoryReadFunction(e)));break;case 115:e=this.fetch16(),this.memoryWriteFunction(e,this.oCOM(this.memoryReadFunction(e)));break;case 116:e=this.fetch16(),this.memoryWriteFunction(e,this.oLSR(this.memoryReadFunction(e)));break;case 118:e=this.fetch16(),this.memoryWriteFunction(e,this.oROR(this.memoryReadFunction(e)));break;case 119:e=this.fetch16(),this.memoryWriteFunction(e,this.oASR(this.memoryReadFunction(e)));break;case 120:e=this.fetch16(),this.memoryWriteFunction(e,this.oASL(this.memoryReadFunction(e)));break;case 121:e=this.fetch16(),this.memoryWriteFunction(e,this.oROL(this.memoryReadFunction(e)));break;case 122:e=this.fetch16(),this.memoryWriteFunction(e,this.oDEC(this.memoryReadFunction(e)));break;case 124:e=this.fetch16(),this.memoryWriteFunction(e,this.oINC(this.memoryReadFunction(e)));break;case 125:e=this.fetch16(),s=this.memoryReadFunction(e),this.regCC&=-15,this.regCC|=h[s];break;case 126:e=this.fetch16(),this.regPC=e;break;case 127:e=this.fetch16(),this.memoryWriteFunction(e,0),this.regCC&=-12,this.regCC|=4;break;case 128:this.regA=this.oSUB(this.regA,this.fetch());break;case 129:this.oCMP(this.regA,this.fetch());break;case 130:this.regA=this.oSBC(this.regA,this.fetch());break;case 131:this.setD(this.oSUB16(this.getD(),this.fetch16()));break;case 132:this.regA=this.oAND(this.regA,this.fetch());break;case 133:this.oAND(this.regA,this.fetch());break;case 134:this.regA=this.fetch(),this.regCC&=-15,this.regCC|=h[255&this.regA];break;case 136:this.regA=this.oEOR(this.regA,this.fetch());break;case 137:this.regA=this.oADC(this.regA,this.fetch());break;case 138:this.regA=this.oOR(this.regA,this.fetch());break;case 139:this.regA=this.oADD(this.regA,this.fetch());break;case 140:this.oCMP16(this.regX,this.fetch16());break;case 141:e=this.signed(this.fetch()),this.PUSHW(this.regPC),this.regPC+=e;break;case 142:this.regX=this.fetch16(),this.flagsNZ16(this.regX),this.regCC&=-3;break;case 144:e=this.dpadd(),this.regA=this.oSUB(this.regA,this.memoryReadFunction(e));break;case 145:e=this.dpadd(),this.oCMP(this.regA,this.memoryReadFunction(e));break;case 146:e=this.dpadd(),this.regA=this.oSBC(this.regA,this.memoryReadFunction(e));break;case 147:e=this.dpadd(),this.setD(this.oSUB16(this.getD(),this.ReadWord(e)));break;case 148:e=this.dpadd(),this.regA=this.oAND(this.regA,this.memoryReadFunction(e));break;case 149:e=this.dpadd(),this.oAND(this.regA,this.memoryReadFunction(e));break;case 150:e=this.dpadd(),this.regA=this.memoryReadFunction(e),this.regCC&=-15,this.regCC|=h[255&this.regA];break;case 151:e=this.dpadd(),this.memoryWriteFunction(e,this.regA),this.regCC&=-15,this.regCC|=h[255&this.regA];break;case 152:e=this.dpadd(),this.regA=this.oEOR(this.regA,this.memoryReadFunction(e));break;case 153:e=this.dpadd(),this.regA=this.oADC(this.regA,this.memoryReadFunction(e));break;case 154:e=this.dpadd(),this.regA=this.oOR(this.regA,this.memoryReadFunction(e));break;case 155:e=this.dpadd(),this.regA=this.oADD(this.regA,this.memoryReadFunction(e));break;case 156:e=this.dpadd(),this.oCMP16(this.regX,this.ReadWord(e));break;case 157:e=this.dpadd(),this.PUSHW(this.regPC),this.regPC=e;break;case 158:e=this.dpadd(),this.regX=this.ReadWord(e),this.flagsNZ16(this.regX),this.regCC&=-3;break;case 159:e=this.dpadd(),this.WriteWord(e,this.regX),this.flagsNZ16(this.regX),this.regCC&=-3;break;case 160:e=this.PostByte(),this.regA=this.oSUB(this.regA,this.memoryReadFunction(e));break;case 161:e=this.PostByte(),this.oCMP(this.regA,this.memoryReadFunction(e));break;case 162:e=this.PostByte(),this.regA=this.oSBC(this.regA,this.memoryReadFunction(e));break;case 163:e=this.PostByte(),this.setD(this.oSUB16(this.getD(),this.ReadWord(e)));break;case 164:e=this.PostByte(),this.regA=this.oAND(this.regA,this.memoryReadFunction(e));break;case 165:e=this.PostByte(),this.oAND(this.regA,this.memoryReadFunction(e));break;case 166:e=this.PostByte(),this.regA=this.memoryReadFunction(e),this.regCC&=-15,this.regCC|=h[255&this.regA];break;case 167:e=this.PostByte(),this.memoryWriteFunction(e,this.regA),this.regCC&=-15,this.regCC|=h[255&this.regA];break;case 168:e=this.PostByte(),this.regA=this.oEOR(this.regA,this.memoryReadFunction(e));break;case 169:e=this.PostByte(),this.regA=this.oADC(this.regA,this.memoryReadFunction(e));break;case 170:e=this.PostByte(),this.regA=this.oOR(this.regA,this.memoryReadFunction(e));break;case 171:e=this.PostByte(),this.regA=this.oADD(this.regA,this.memoryReadFunction(e));break;case 172:e=this.PostByte(),this.oCMP16(this.regX,this.ReadWord(e));break;case 173:e=this.PostByte(),this.PUSHW(this.regPC),this.regPC=e;break;case 174:e=this.PostByte(),this.regX=this.ReadWord(e),this.flagsNZ16(this.regX),this.regCC&=-3;break;case 175:e=this.PostByte(),this.WriteWord(e,this.regX),this.flagsNZ16(this.regX),this.regCC&=-3;break;case 176:e=this.fetch16(),this.regA=this.oSUB(this.regA,this.memoryReadFunction(e));break;case 177:e=this.fetch16(),this.oCMP(this.regA,this.memoryReadFunction(e));break;case 178:e=this.fetch16(),this.regA=this.oSBC(this.regA,this.memoryReadFunction(e));break;case 179:e=this.fetch16(),this.setD(this.oSUB16(this.getD(),this.ReadWord(e)));break;case 180:e=this.fetch16(),this.regA=this.oAND(this.regA,this.memoryReadFunction(e));break;case 181:e=this.fetch16(),this.oAND(this.regA,this.memoryReadFunction(e));break;case 182:e=this.fetch16(),this.regA=this.memoryReadFunction(e),this.regCC&=-15,this.regCC|=h[255&this.regA];break;case 183:e=this.fetch16(),this.memoryWriteFunction(e,this.regA),this.regCC&=-15,this.regCC|=h[255&this.regA];break;case 184:e=this.fetch16(),this.regA=this.oEOR(this.regA,this.memoryReadFunction(e));break;case 185:e=this.fetch16(),this.regA=this.oADC(this.regA,this.memoryReadFunction(e));break;case 186:e=this.fetch16(),this.regA=this.oOR(this.regA,this.memoryReadFunction(e));break;case 187:e=this.fetch16(),this.regA=this.oADD(this.regA,this.memoryReadFunction(e));break;case 188:e=this.fetch16(),this.oCMP16(this.regX,this.ReadWord(e));break;case 189:e=this.fetch16(),this.PUSHW(this.regPC),this.regPC=e;break;case 190:e=this.fetch16(),this.regX=this.ReadWord(e),this.flagsNZ16(this.regX),this.regCC&=-3;break;case 191:e=this.fetch16(),this.WriteWord(e,this.regX),this.flagsNZ16(this.regX),this.regCC&=-3;break;case 192:this.regB=this.oSUB(this.regB,this.fetch());break;case 193:this.oCMP(this.regB,this.fetch());break;case 194:this.regB=this.oSBC(this.regB,this.fetch());break;case 195:this.setD(this.oADD16(this.getD(),this.fetch16()));break;case 196:this.regB=this.oAND(this.regB,this.fetch());break;case 197:this.oAND(this.regB,this.fetch());break;case 198:this.regB=this.fetch(),this.regCC&=-15,this.regCC|=h[255&this.regB];break;case 200:this.regB=this.oEOR(this.regB,this.fetch());break;case 201:this.regB=this.oADC(this.regB,this.fetch());break;case 202:this.regB=this.oOR(this.regB,this.fetch());break;case 203:this.regB=this.oADD(this.regB,this.fetch());break;case 204:e=this.fetch16(),this.setD(e),this.flagsNZ16(e),this.regCC&=-3;break;case 206:this.regU=this.fetch16(),this.flagsNZ16(this.regU),this.regCC&=-3;break;case 208:e=this.dpadd(),this.regB=this.oSUB(this.regB,this.memoryReadFunction(e));break;case 209:e=this.dpadd(),this.oCMP(this.regB,this.memoryReadFunction(e));break;case 210:e=this.dpadd(),this.regB=this.oSBC(this.regB,this.memoryReadFunction(e));break;case 211:e=this.dpadd(),this.setD(this.oADD16(this.getD(),this.ReadWord(e)));break;case 212:e=this.dpadd(),this.regB=this.oAND(this.regB,this.memoryReadFunction(e));break;case 213:e=this.dpadd(),this.oAND(this.regB,this.memoryReadFunction(e));break;case 214:e=this.dpadd(),this.regB=this.memoryReadFunction(e),this.regCC&=-15,this.regCC|=h[255&this.regB];break;case 215:e=this.dpadd(),this.memoryWriteFunction(e,this.regB),this.regCC&=-15,this.regCC|=h[255&this.regB];break;case 216:e=this.dpadd(),this.regB=this.oEOR(this.regB,this.memoryReadFunction(e));break;case 217:e=this.dpadd(),this.regB=this.oADC(this.regB,this.memoryReadFunction(e));break;case 218:e=this.dpadd(),this.regB=this.oOR(this.regB,this.memoryReadFunction(e));break;case 219:e=this.dpadd(),this.regB=this.oADD(this.regB,this.memoryReadFunction(e));break;case 220:e=this.dpadd(),s=this.ReadWord(e),this.setD(s),this.flagsNZ16(s),this.regCC&=-3;break;case 221:e=this.dpadd(),this.WriteWord(e,this.getD()),this.flagsNZ16(this.getD()),this.regCC&=-3;break;case 222:e=this.dpadd(),this.regU=this.ReadWord(e),this.flagsNZ16(this.regU),this.regCC&=-3;break;case 223:e=this.dpadd(),this.WriteWord(e,this.regU),this.flagsNZ16(this.regU),this.regCC&=-3;break;case 224:e=this.PostByte(),this.regB=this.oSUB(this.regB,this.memoryReadFunction(e));break;case 225:e=this.PostByte(),this.oCMP(this.regB,this.memoryReadFunction(e));break;case 226:e=this.PostByte(),this.regB=this.oSBC(this.regB,this.memoryReadFunction(e));break;case 227:e=this.PostByte(),this.setD(this.oADD16(this.getD(),this.ReadWord(e)));break;case 228:e=this.PostByte(),this.regB=this.oAND(this.regB,this.memoryReadFunction(e));break;case 229:e=this.PostByte(),this.oAND(this.regB,this.memoryReadFunction(e));break;case 230:e=this.PostByte(),this.regB=this.memoryReadFunction(e),this.regCC&=-15,this.regCC|=h[255&this.regB];break;case 231:e=this.PostByte(),this.memoryWriteFunction(e,this.regB),this.regCC&=-15,this.regCC|=h[255&this.regB];break;case 232:e=this.PostByte(),this.regB=this.oEOR(this.regB,this.memoryReadFunction(e));break;case 233:e=this.PostByte(),this.regB=this.oADC(this.regB,this.memoryReadFunction(e));break;case 234:e=this.PostByte(),this.regB=this.oOR(this.regB,this.memoryReadFunction(e));break;case 235:e=this.PostByte(),this.regB=this.oADD(this.regB,this.memoryReadFunction(e));break;case 236:e=this.PostByte(),s=this.ReadWord(e),this.setD(s),this.flagsNZ16(s),this.regCC&=-3;break;case 237:e=this.PostByte(),this.WriteWord(e,this.getD()),this.flagsNZ16(this.getD()),this.regCC&=-3;break;case 238:e=this.PostByte(),this.regU=this.ReadWord(e),this.flagsNZ16(this.regU),this.regCC&=-3;break;case 239:e=this.PostByte(),this.WriteWord(e,this.regU),this.flagsNZ16(this.regU),this.regCC&=-3;break;case 240:e=this.fetch16(),this.regB=this.oSUB(this.regB,this.memoryReadFunction(e));break;case 241:e=this.fetch16(),this.oCMP(this.regB,this.memoryReadFunction(e));break;case 242:e=this.fetch16(),this.regB=this.oSBC(this.regB,this.memoryReadFunction(e));break;case 243:e=this.fetch16(),this.setD(this.oADD16(this.getD(),this.ReadWord(e)));break;case 244:e=this.fetch16(),this.regB=this.oAND(this.regB,this.memoryReadFunction(e));break;case 245:e=this.fetch16(),this.oAND(this.regB,this.memoryReadFunction(e));break;case 246:e=this.fetch16(),this.regB=this.memoryReadFunction(e),this.regCC&=-15,this.regCC|=h[255&this.regB];break;case 247:e=this.fetch16(),this.memoryWriteFunction(e,this.regB),this.regCC&=-15,this.regCC|=h[255&this.regB];break;case 248:e=this.fetch16(),this.regB=this.oEOR(this.regB,this.memoryReadFunction(e));break;case 249:e=this.fetch16(),this.regB=this.oADC(this.regB,this.memoryReadFunction(e));break;case 250:e=this.fetch16(),this.regB=this.oOR(this.regB,this.memoryReadFunction(e));break;case 251:e=this.fetch16(),this.regB=this.oADD(this.regB,this.memoryReadFunction(e));break;case 252:e=this.fetch16(),s=this.ReadWord(e),this.setD(s),this.flagsNZ16(s),this.regCC&=-3;break;case 253:e=this.fetch16(),this.WriteWord(e,this.getD()),this.flagsNZ16(this.getD()),this.regCC&=-3;break;case 254:e=this.fetch16(),this.regU=this.ReadWord(e),this.flagsNZ16(this.regU),this.regCC&=-3;break;case 255:e=this.fetch16(),this.WriteWord(e,this.regU),this.flagsNZ16(this.regU),this.regCC&=-3;break;case 16:switch(o=this.fetch(),this.tickCount+=a[o],o){case 33:e=this.signed16(this.fetch16());break;case 34:e=this.signed16(this.fetch16()),5&this.regCC||(this.regPC+=e,this.tickCount++);break;case 35:e=this.signed16(this.fetch16()),5&this.regCC&&(this.regPC+=e,this.tickCount++);break;case 36:e=this.signed16(this.fetch16()),1&this.regCC||(this.regPC+=e,this.tickCount++);break;case 37:e=this.signed16(this.fetch16()),1&this.regCC&&(this.regPC+=e,this.tickCount++);break;case 38:e=this.signed16(this.fetch16()),4&this.regCC||(this.regPC+=e,this.tickCount++);break;case 39:e=this.signed16(this.fetch16()),4&this.regCC&&(this.regPC+=e,this.tickCount++);break;case 40:e=this.signed16(this.fetch16()),2&this.regCC||(this.regPC+=e,this.tickCount++);break;case 41:e=this.signed16(this.fetch16()),2&this.regCC&&(this.regPC+=e,this.tickCount++);break;case 42:e=this.signed16(this.fetch16()),8&this.regCC||(this.regPC+=e,this.tickCount++);break;case 43:e=this.signed16(this.fetch16()),8&this.regCC&&(this.regPC+=e,this.tickCount++);break;case 44:e=this.signed16(this.fetch16()),8&this.regCC^(2&this.regCC)<<2||(this.regPC+=e,this.tickCount++);break;case 45:e=this.signed16(this.fetch16()),8&this.regCC^(2&this.regCC)<<2&&(this.regPC+=e,this.tickCount++);break;case 46:e=this.signed16(this.fetch16()),8&this.regCC^(2&this.regCC)<<2||4&this.regCC||(this.regPC+=e,this.tickCount++);break;case 47:e=this.signed16(this.fetch16()),(8&this.regCC^(2&this.regCC)<<2||4&this.regCC)&&(this.regPC+=e,this.tickCount++);break;case 63:console.log("SWI2 is untested!"),this.regCC|=128,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regPC=this.ReadWord(65524);break;case 131:this.oCMP16(this.getD(),this.fetch16());break;case 140:this.oCMP16(this.regY,this.fetch16());break;case 142:this.regY=this.fetch16(),this.flagsNZ16(this.regY),this.regCC&=-3;break;case 147:e=this.dpadd(),this.oCMP16(this.getD(),this.ReadWord(e));break;case 156:e=this.dpadd(),this.oCMP16(this.regY,this.ReadWord(e));break;case 158:e=this.dpadd(),this.regY=this.ReadWord(e),this.flagsNZ16(this.regY),this.regCC&=-3;break;case 159:e=this.dpadd(),this.WriteWord(e,this.regY),this.flagsNZ16(this.regY),this.regCC&=-3;break;case 163:e=this.PostByte(),this.oCMP16(this.getD(),this.ReadWord(e));break;case 172:e=this.PostByte(),this.oCMP16(this.regY,this.ReadWord(e));break;case 174:e=this.PostByte(),this.regY=this.ReadWord(e),this.flagsNZ16(this.regY),this.regCC&=-3;break;case 175:e=this.PostByte(),this.WriteWord(e,this.regY),this.flagsNZ16(this.regY),this.regCC&=-3;break;case 179:e=this.fetch16(),this.oCMP16(this.getD(),this.ReadWord(e));break;case 188:e=this.fetch16(),this.oCMP16(this.regY,this.ReadWord(e));break;case 190:e=this.fetch16(),this.regY=this.ReadWord(e),this.flagsNZ16(this.regY),this.regCC&=-3;break;case 191:e=this.fetch16(),this.WriteWord(e,this.regY),this.flagsNZ16(this.regY),this.regCC&=-3;break;case 206:this.regS=this.fetch16(),this.flagsNZ16(this.regS),this.regCC&=-3;break;case 222:e=this.dpadd(),this.regS=this.ReadWord(e),this.flagsNZ16(this.regS),this.regCC&=-3;break;case 223:e=this.dpadd(),this.WriteWord(e,this.regS),this.flagsNZ16(this.regS),this.regCC&=-3;break;case 238:e=this.PostByte(),this.regS=this.ReadWord(e),this.flagsNZ16(this.regS),this.regCC&=-3;break;case 239:e=this.PostByte(),this.WriteWord(e,this.regS),this.flagsNZ16(this.regS),this.regCC&=-3;break;case 254:e=this.fetch16(),this.regS=this.ReadWord(e),this.flagsNZ16(this.regS),this.regCC&=-3;break;case 255:e=this.fetch16(),this.WriteWord(e,this.regS),this.flagsNZ16(this.regS),this.regCC&=-3;break;default:throw new Error("CPU_OPCODE_INVALID_PAGE1_"+o)}break;case 17:switch(o=this.fetch(),this.tickCount+=a[o],o){case 63:console.log("SWI3 is untested!"),this.regCC|=128,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regPC=this.ReadWord(65522);break;case 131:this.oCMP16(this.regU,this.fetch16());break;case 140:this.oCMP16(this.regS,this.fetch16());break;case 147:e=this.dpadd(),this.oCMP16(this.regU,this.ReadWord(e));break;case 156:e=this.dpadd(),this.oCMP16(this.regS,this.ReadWord(e));break;case 163:e=this.PostByte(),this.oCMP16(this.regU,this.ReadWord(e));break;case 172:e=this.PostByte(),this.oCMP16(this.regS,this.ReadWord(e));break;case 179:e=this.fetch16(),this.oCMP16(this.regU,this.ReadWord(e));break;case 188:e=this.fetch16(),this.oCMP16(this.regS,this.ReadWord(e));break;default:throw new Error("CPU_OPCODE_INVALID_PAGE2_"+o)}break;default:throw new Error("CPU_OPCODE_INVALID_"+o)}return this.regA&=255,this.regB&=255,this.regCC&=255,this.regDP&=255,this.regX&=65535,this.regY&=65535,this.regU&=65535,this.regS&=65535,this.regPC&=65535,this.tickCount-t}reset(){this.irqPending=!1,this.firqPending=!1,this.regDP=0,this.missedIRQ=0,this.missedFIRQ=0,this.irqCount=0,this.firqCount=0,this.regCC=80,this.regPC=this.ReadWord(65534),i("exec reset",this.regPC),this.tickCount=0}_executeNmi(){i("exec nmi"),this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.regCC|=128,this.PUSHB(this.regCC),this.regCC|=80,this.regPC=this.ReadWord(65532),this.tickCount+=19}_executeFirq(){i("EXEC_FIRQ",this.tickCount),this.regCC&=-129,this.PUSHW(this.regPC),this.PUSHB(this.regCC),this.regCC|=80,this.regPC=this.ReadWord(65526),this.tickCount+=10}_executeIrq(){i("EXEC_IRQ",this.tickCount),this.regCC|=128,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regCC|=16,this.regPC=this.ReadWord(65528),this.tickCount+=19}steps(t=1){const e=this.tickCount,s=t;let r=0;for(;t>0;){const e=this.step();e<1&&(i("WARNING, invalid step detected:",{invalidStepDetected:r,ticksToRun:s,ticks:t,pc:this.regPC}),r++,t--),t-=e}if(r&&s>1&&r===s)throw new Error("INVALID_CPU_STATE_DETECTED");return this.tickCount-e}getState(){return{regPC:this.regPC,regS:this.regS,regU:this.regU,regA:this.regA,regB:this.regB,regX:this.regX,regY:this.regY,regDP:this.regDP,regCC:this.regCC,missedIRQ:this.missedIRQ,missedFIRQ:this.missedFIRQ,irqCount:this.irqCount,firqCount:this.firqCount,nmiCount:this.nmiCount,tickCount:this.tickCount}}setState(t){["regPC","regS","regU","regA","regB","regX","regY","regDP","regCC","missedIRQ","missedFIRQ","irqCount","firqCount","nmiCount","tickCount"].forEach(e=>{t&&void 0!==t[e]&&(this[e]=t[e])})}irq(){i("SCHEDULE_IRQ %o",{tickCount:this.tickCount,missedIRQ:this.missedIRQ}),this.irqPending=!0}firq(){i("SCHEDULE_FIRQ %o",{tickCount:this.tickCount,missedFIRQ:this.missedFIRQ}),this.firqPending=!0}nmi(){i("schedule nmi, probably broken as untested"),this.nmiCount++,this._executeNmi()}set(t,e){switch(t.toUpperCase()){case"PC":this.regPC=e;break;case"A":this.regA=e;break;case"B":this.regB=e;break;case"X":this.regX=e;break;case"Y":this.regY=e;break;case"SP":this.regS=e;break;case"U":this.regU=e;break;case"FLAGS":this.regCC=e;break;default:console.log("INVALID REGISTER",t)}}flagsToString(){const t="EFHINZVC";let e="";for(let s=0;s<8;s++){e+=0===(this.regCC&128>>s)?t[s].toLowerCase():t[s]}return e}}},function(t,e,s){"use strict";const i=s(42);t.exports={getInstance:function(t){return new a(t)}};const r=["string","uint8","bcd"];class a{constructor(t){this.memoryPosition=void 0,t&&t.knownValues&&(this.memoryPosition=t.knownValues.filter(t=>Number.isInteger(t.offset)&&r.includes(t.type))),this.oldState={videoRam:[],dmdShadedBuffer:[],lampState:[],solenoidState:[],inputState:[]},this.videoRam=[]}getVideoRamDiff(t=[]){let e=!1;for(let s=0;s<16;s++){const i=t.slice(512*s,512*(s+1));(!this.oldState.videoRam[s]||!a.arraysEqual(i,this.oldState.videoRam[s]))&&(e=!0,this.videoRam[s]=i,this.oldState.videoRam[s]=Uint8Array.from(i))}return e}static arraysEqual(t,e){if(t===e)return!0;if(!t||!e||t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0}parseMemoryPosition(t){if(this.memoryPosition)return this.memoryPosition.map(e=>{switch(e.type){case"uint8":const s=e.length||1;if(1===s)e.value=t[e.offset];else{e.value=0;for(let i=0;i<s;i++){const r=8*(s-i-1);e.value+=t[e.offset+i]<<r}}break;case"string":let r=e.offset,a="";for(;t[r]>31&&t[r]<128&&a.length<32;)a+=String.fromCharCode(t[r++]);e.value=a;break;case"bcd":const h=e.length||2,o=i.toNumber(t.subarray(e.offset,e.offset+h),h);e.value=o;break;default:e.value="TYPE_INVALID"}return e})}getChangedAsicState(t,e=!0){const s=!a.arraysEqual(t.display.dmdShadedBuffer,this.oldState.dmdShadedBuffer),i=!a.arraysEqual(t.wpc.lampState,this.oldState.lampState),r=!a.arraysEqual(t.wpc.solenoidState,this.oldState.solenoidState),h=!a.arraysEqual(t.wpc.inputState,this.oldState.inputState);s&&(this.oldState.dmdShadedBuffer=Uint8Array.from(t.display.dmdShadedBuffer)),i&&(this.oldState.lampState=Uint8Array.from(t.wpc.lampState)),r&&(this.oldState.solenoidState=Uint8Array.from(t.wpc.solenoidState)),h&&(this.oldState.inputState=Uint8Array.from(t.wpc.inputState));const o=!1!==e&&this.getVideoRamDiff(t.display.videoRam),n=this.parseMemoryPosition(t.ram);return{ram:!1!==e&&t.ram,memoryPosition:n,sound:t.sound,wpc:{diagnosticLed:t.wpc.diagnosticLed,lampState:i?t.wpc.lampState:void 0,solenoidState:r?t.wpc.solenoidState:void 0,generalIlluminationState:t.wpc.generalIlluminationState,inputState:h?t.wpc.inputState:void 0,diagnosticLedToggleCount:t.wpc.diagnosticLedToggleCount,midnightModeEnabled:t.wpc.midnightModeEnabled,irqEnabled:t.wpc.irqEnabled,activeRomBank:t.wpc.activeRomBank,time:t.wpc.time,blankSignalHigh:t.wpc.blankSignalHigh,watchdogExpiredCounter:t.wpc.watchdogExpiredCounter,watchdogTicks:t.wpc.watchdogTicks,zeroCrossFlag:t.wpc.zeroCrossFlag,inputSwitchMatrixActiveColumn:t.wpc.inputSwitchMatrixActiveColumn,lampRow:t.wpc.lampRow,lampColumn:t.wpc.lampColumn,wpcSecureScrambler:t.wpc.wpcSecureScrambler},dmd:{scanline:t.display.scanline,dmdPageMapping:t.display.dmdPageMapping,activepage:t.display.activepage,videoRam:o?this.videoRam:void 0,dmdShadedBuffer:s?t.display.dmdShadedBuffer:void 0,videoOutputBuffer:t.display.videoOutputBuffer,nextActivePage:t.display.nextActivePage,requestFIRQ:t.display.requestFIRQ,ticksUpdateDmd:t.display.ticksUpdateDmd}}}}},function(t,e,s){"use strict";t.exports={toNumber:function(t){let e=0,s=1;for(let i=0;i<t.length;i++)e+=(15&t[t.length-1-i])*s,e+=(t[t.length-1-i]>>4&15)*s*10,s*=100;return e},toBCD:function(t){const e=new Uint8Array(32).fill(0);let s=0;for(;0!==t;)e[s]=t%10,t=t/10|0,e[s]+=t%10<<4,t=t/10|0,s++;return e.subarray(0,s).reverse()}}}]);